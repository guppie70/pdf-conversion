@page "/generate-hierarchy"
@using PdfConversion.Models
@using PdfConversion.Services
@inject IHierarchyService HierarchyService
@inject ILogger<GenerateHierarchy> Logger

<PageTitle>Generate Hierarchy</PageTitle>

<div class="generate-hierarchy-page">
    <div class="page-header">
        <h3>Document Hierarchy Editor</h3>
        <div class="header-actions">
            <button class="btn btn-primary" @onclick="LoadHierarchyAsync">
                <i class="bi bi-folder-open"></i> Load
            </button>
            <button class="btn btn-success" @onclick="SaveHierarchyAsync" disabled="@(!HasChanges)">
                <i class="bi bi-save"></i> Save
            </button>
            <button class="btn btn-secondary" disabled="true">
                <i class="bi bi-magic"></i> Generate with AI (Coming Soon)
            </button>
        </div>
    </div>

    <div class="hierarchy-workspace">
        <div class="left-panel">
            <div class="panel-header">
                <h5>Hierarchy Tree</h5>
            </div>
            <div class="panel-content">
                @if (CurrentHierarchy != null)
                {
                    <HierarchyTreeView RootItem="CurrentHierarchy.Root"
                                     OnItemSelected="HandleItemSelected"
                                     OnItemEdited="HandleItemEdited" />
                }
                else
                {
                    <div class="text-center p-5 text-muted">
                        <i class="bi bi-file-earmark-text" style="font-size: 3rem;"></i>
                        <p class="mt-3">Load a hierarchy file to get started</p>
                    </div>
                }
            </div>
        </div>

        <div class="right-panel">
            <AvailableHeadersPanel @ref="HeadersPanel"
                                  NormalizedXmlPath="@NormalizedXmlPath"
                                  HierarchyXmlPath="@HierarchyXmlPath"
                                  OnHeadersChanged="HandleHeadersChanged" />
        </div>
    </div>
</div>

@code {
    private HierarchyStructure? CurrentHierarchy { get; set; }
    private HierarchyItem? SelectedItem { get; set; }
    private bool HasChanges { get; set; }
    private AvailableHeadersPanel? HeadersPanel { get; set; }

    // File paths for the headers panel - using taxxor/ar25-1 test project
    private string? NormalizedXmlPath => "/app/data/input/taxxor/projects/ar25-1/docling-output.xml";
    private string? HierarchyXmlPath => "/app/data/input/taxxor/projects/ar25-1/metadata/sample-hierarchy.xml";

    private async Task LoadHierarchyAsync()
    {
        try
        {
            // Load the sample hierarchy for taxxor/ar25-1
            var filePath = "/app/data/input/taxxor/projects/ar25-1/metadata/sample-hierarchy.xml";
            CurrentHierarchy = await HierarchyService.LoadHierarchyAsync(filePath);
            HasChanges = false;
            Logger.LogInformation("Loaded hierarchy from {Path}", filePath);

            // Refresh headers panel to mark used headers
            if (HeadersPanel != null)
            {
                await HeadersPanel.LoadHeadersAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load hierarchy");
        }
    }

    private async Task SaveHierarchyAsync()
    {
        try
        {
            if (CurrentHierarchy == null) return;

            var filePath = "/app/data/output/hierarchy-edited.xml";
            await HierarchyService.SaveHierarchyAsync(filePath, CurrentHierarchy);
            HasChanges = false;
            Logger.LogInformation("Saved hierarchy to {Path}", filePath);

            // Refresh headers panel to update used status
            if (HeadersPanel != null)
            {
                await HeadersPanel.RefreshUsedStatusAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save hierarchy");
        }
    }

    private void HandleItemSelected(HierarchyItem item)
    {
        SelectedItem = item;
    }

    private void HandleItemEdited(HierarchyItem item)
    {
        HasChanges = true;
    }

    private async Task HandleHeadersChanged()
    {
        // Called when headers are loaded/refreshed
        StateHasChanged();
    }

    private string GetConfidenceColor(int confidence)
    {
        return confidence >= 80 ? "success" : confidence >= 70 ? "warning" : "danger";
    }
}
