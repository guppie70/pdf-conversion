@page "/generate-hierarchy"
@using PdfConversion.Models
@using PdfConversion.Services
@using PdfConversion.Shared
@inject IHierarchyService HierarchyService
@inject IProjectLabelService ProjectLabelService
@inject IUserSelectionService UserSelectionService
@inject IHeaderExtractionService HeaderExtractionService
@inject IXsltTransformationService XsltTransformationService
@inject IHierarchyGeneratorService HierarchyGenerator
@inject IOllamaService OllamaService
@inject IJSRuntime JSRuntime
@inject ILogger<GenerateHierarchy> Logger

<PageTitle>Generate Hierarchy</PageTitle>

<div class="generate-hierarchy-page">
    <div class="page-header">
        <h3>Document Hierarchy Editor</h3>
        <div class="header-actions">
            <button class="btn btn-success" @onclick="SaveHierarchyAsync" disabled="@(!HasChanges || string.IsNullOrEmpty(SelectedProject))">
                <i class="bi bi-save"></i> Save
            </button>
            <button class="btn btn-primary"
                    @onclick="ShowAiGenerationModal"
                    disabled="@(string.IsNullOrEmpty(SelectedSourceXml) || !_ollamaHealthy)">
                <i class="bi bi-robot"></i> Generate with AI
            </button>
        </div>
    </div>

    <div class="settings-panel">
        <label>Source XML:</label>
        <ProjectFileSelector
            FileGroups="@ProjectFileGroups"
            SelectedValue="@GetSelectedFilePath()"
            OnSelectionChanged="@OnFilePathChangedFromComponent"
            CssClass="form-select"
            PlaceholderText="Select XML..." />

        <label>Hierarchy XML:</label>
        <select class="form-select"
                @bind="SelectedHierarchyXml"
                @bind:after="OnHierarchyXmlChangedAsync"
                disabled="@string.IsNullOrEmpty(SelectedSourceXml)">
            <option value="">Select hierarchy...</option>
            @foreach (var file in HierarchyXmlFiles)
            {
                <option value="@file">@Path.GetFileName(file)</option>
            }
        </select>
    </div>

    @if (!string.IsNullOrEmpty(AlertMessage))
    {
        <div class="alert alert-@AlertType alert-dismissible fade show mt-2" role="alert">
            @AlertMessage
            <button type="button" class="btn-close" @onclick="() => AlertMessage = null" aria-label="Close"></button>
        </div>
    }

    @if (_validationResult != null && !_validationResult.IsValid)
    {
        <div class="alert alert-warning mt-2">
            <div class="d-flex align-items-start">
                <i class="bi bi-exclamation-triangle-fill me-2 mt-1" style="font-size: 1.2em;"></i>
                <div class="flex-grow-1">
                    <h6 class="mb-2">⚠️ Hierarchy Contains Hallucinations</h6>
                    <p class="mb-2">@_validationResult.Summary</p>
                    <details>
                        <summary class="text-decoration-underline" style="cursor: pointer;">
                            Show hallucinated items (@_validationResult.HallucinatedItems.Count)
                        </summary>
                        <ul class="mt-2 mb-0">
                            @foreach (var item in _validationResult.HallucinatedItems.Take(20))
                            {
                                <li><code>@item</code></li>
                            }
                            @if (_validationResult.HallucinatedItems.Count > 20)
                            {
                                <li class="text-muted">... and @(_validationResult.HallucinatedItems.Count - 20) more</li>
                            }
                        </ul>
                    </details>
                    <p class="mb-0 mt-2 small">
                        <strong>What this means:</strong> These section names don't exist in your source document.
                        You can manually remove them below or regenerate with different settings.
                    </p>
                </div>
            </div>
        </div>
    }

    <div class="hierarchy-workspace">
        <div class="left-panel">
            <div class="panel-header">
                <h5>Hierarchy Tree</h5>
            </div>
            <div class="panel-content">
                @if (CurrentHierarchy != null)
                {
                    <HierarchyTreeView RootItem="CurrentHierarchy.Root"
                                     OnItemSelected="HandleItemSelected"
                                     OnItemEdited="HandleItemEdited"
                                     OnEditRequest="HandleEditRequest" />
                }
                else
                {
                    <div class="text-center p-5 text-muted">
                        <i class="bi bi-file-earmark-text" style="font-size: 3rem;"></i>
                        <p class="mt-3">Load a hierarchy file to get started</p>
                    </div>
                }
            </div>
        </div>

        <div class="right-panel">
            <AvailableHeadersPanel @ref="HeadersPanel"
                                  NormalizedXmlPath="@NormalizedXmlPath"
                                  HierarchyXmlPath="@HierarchyXmlPath"
                                  OnHeadersChanged="HandleHeadersChanged" />
        </div>
    </div>

    @if (ShowEditor && EditingItem != null)
    {
        <HierarchyItemEditor SelectedItem="EditingItem"
                            OnItemUpdated="HandleItemUpdated"
                            OnClosed="CloseEditor" />
    }

    @if (_showAiModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">AI Hierarchy Generation</h5>
                        <button type="button" class="btn-close" @onclick="CloseAiModal" disabled="@_isGeneratingAi"></button>
                    </div>
                    <div class="modal-body">
                        @if (_aiError != null)
                        {
                            <div class="alert alert-danger alert-dismissible">
                                @_aiError
                                <button type="button" class="btn-close" @onclick="() => _aiError = null"></button>
                            </div>
                        }

                        <!-- XSLT Selection -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">XSLT Transformation</label>
                            <select class="form-select" @bind="_selectedAiXslt">
                                <option value="">-- Select XSLT File --</option>
                                @foreach (var file in _availableXsltFiles)
                                {
                                    <option value="@file">@file.Replace("/app/xslt/", "")</option>
                                }
                            </select>
                            @if (!string.IsNullOrEmpty(_selectedAiXslt))
                            {
                                <small class="text-muted d-block mt-1">
                                    @_selectedAiXslt.Replace("/app/xslt/", "") selected
                                </small>
                            }
                        </div>

                        <!-- Example Hierarchies Selection -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                Training Examples
                                <small class="text-muted">(select 2-3 for best results)</small>
                            </label>
                            <input type="text"
                                   class="form-control form-control-sm mb-2"
                                   placeholder="Search examples (e.g., 'optiver', 'philips')..."
                                   @bind="_hierarchySearchFilter"
                                   @bind:event="oninput" />

                            <div class="example-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                                @{
                                    var filteredExamples = string.IsNullOrWhiteSpace(_hierarchySearchFilter)
                                        ? _exampleHierarchies
                                        : _exampleHierarchies.Where(e =>
                                            e.DisplayName.Contains(_hierarchySearchFilter, StringComparison.OrdinalIgnoreCase)
                                        ).ToList();
                                }
                                @foreach (var example in filteredExamples)
                                {
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="@example.Path"
                                               checked="@example.IsSelected"
                                               @onchange="@(async () => await ToggleExample(example))" />
                                        <label class="form-check-label small" for="@example.Path">
                                            @example.DisplayName
                                        </label>
                                    </div>
                                }
                            </div>
                            <small class="text-muted d-block mt-1">
                                @_exampleHierarchies.Count(e => e.IsSelected) selected
                                @if (!string.IsNullOrWhiteSpace(_hierarchySearchFilter))
                                {
                                    <text> (showing @filteredExamples.Count() of @_exampleHierarchies.Count)</text>
                                }
                            </small>
                        </div>

                        <!-- Model Selection -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">AI Model</label>
                            <select class="form-select" @bind="_selectedAiModel">
                                @foreach (var model in _availableAiModels)
                                {
                                    <option value="@model.Name">
                                        @model.Name
                                        @if (model.Details != null)
                                        {
                                            <text> (@model.Details.ParameterSize)</text>
                                        }
                                    </option>
                                }
                            </select>
                        </div>

                        <!-- Temperature -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                Temperature: @_aiTemperature.ToString("F1")
                            </label>
                            <input type="range"
                                   class="form-range"
                                   min="0.0"
                                   max="1.0"
                                   step="0.1"
                                   @bind="_aiTemperature" />
                            <small class="text-muted d-block">
                                Lower = more consistent, Higher = more creative
                            </small>
                        </div>

                        @if (_isGeneratingAi)
                        {
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Generating...</span>
                                </div>
                                <p class="mt-2 text-muted">Generating hierarchy... This may take 30-60 seconds.</p>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseAiModal" disabled="@_isGeneratingAi">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn btn-primary"
                                @onclick="GenerateWithAi"
                                disabled="@(_isGeneratingAi || _exampleHierarchies.Count(e => e.IsSelected) == 0 || string.IsNullOrEmpty(_selectedAiXslt))">
                            <i class="bi bi-robot"></i> Generate
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private HierarchyStructure? CurrentHierarchy { get; set; }
    private HierarchyItem? SelectedItem { get; set; }
    private bool HasChanges { get; set; }
    private AvailableHeadersPanel? HeadersPanel { get; set; }

    // Editor panel state
    private HierarchyItem? EditingItem { get; set; }
    private bool ShowEditor => EditingItem != null;

    // AI Generation state
    private bool _showAiModal = false;
    private bool _isGeneratingAi = false;
    private bool _ollamaHealthy = false;
    private bool _isAiGenerated = false;  // Track if current hierarchy is AI-generated
    private string? _aiError = null;
    private HierarchyValidationResult? _validationResult = null;
    private List<ExampleHierarchy> _exampleHierarchies = new();
    private string _hierarchySearchFilter = string.Empty;
    private List<OllamaModel> _availableAiModels = new();
    private string _selectedAiModel = "deepseek-coder:33b";
    private double _aiTemperature = 0.3;
    private string _selectedAiXslt = "/app/xslt/transformation.xslt";
    private List<string> _availableXsltFiles = new();

    // ExampleHierarchy class for training data
    private class ExampleHierarchy
    {
        public string Path { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
        public bool IsSelected { get; set; }
        public string? Content { get; set; }
    }

    // Project and file selection state
    private List<ProjectInfo> Projects { get; set; } = new();
    private string? SelectedProject { get; set; } // Format: "customer/project-id"
    private string? SelectedSourceXml { get; set; } // Full path to XML file
    private string? SelectedXsltFile { get; set; } // XSLT file path from user selections
    private List<string> HierarchyXmlFiles { get; set; } = new();
    private string? SelectedHierarchyXml { get; set; }
    private bool IsLoadingDocument { get; set; }
    private bool IsLoadingHierarchy { get; set; }

    // ProjectFileSelector helper properties
    private List<ProjectFileGroup> ProjectFileGroups
    {
        get
        {
            if (Projects == null || !Projects.Any())
                return new();

            var groups = new List<ProjectFileGroup>();

            foreach (var project in Projects)
            {
                var customer = project.Customer;
                var projectId = project.ProjectId;

                // Group 1: Input files for this project
                var inputDir = $"/app/data/input/{customer}/projects/{projectId}";
                if (Directory.Exists(inputDir))
                {
                    var inputFiles = Directory.GetFiles(inputDir, "*.xml")
                        .Where(f => !f.Contains("/metadata/"))
                        .Select(f => new ProjectFile
                        {
                            FileName = Path.GetFileName(f),
                            FullPath = f
                        })
                        .ToList();

                    if (inputFiles.Any())
                    {
                        groups.Add(new ProjectFileGroup
                        {
                            Customer = customer,
                            ProjectId = projectId,
                            ProjectName = $"{project.CustomLabel ?? project.ProjectId} - Input Files",
                            Files = inputFiles
                        });
                    }
                }

                // Group 2: Output files for this project
                var outputDir = $"/app/data/output/{customer}/projects/{projectId}";
                if (Directory.Exists(outputDir))
                {
                    var outputFiles = Directory.GetFiles(outputDir, "*.xml")
                        .Where(f => !Path.GetFileName(f).Equals("hierarchy.xml", StringComparison.OrdinalIgnoreCase))
                        .Select(f => new ProjectFile
                        {
                            FileName = Path.GetFileName(f),
                            FullPath = f
                        })
                        .ToList();

                    if (outputFiles.Any())
                    {
                        groups.Add(new ProjectFileGroup
                        {
                            Customer = customer,
                            ProjectId = projectId,
                            ProjectName = $"{project.CustomLabel ?? project.ProjectId} - Output Files",
                            Files = outputFiles
                        });
                    }
                }
            }

            return groups;
        }
    }

    private string GetSelectedFilePath() =>
        !string.IsNullOrEmpty(SelectedSourceXml) ? SelectedSourceXml : string.Empty;

    private async Task OnFilePathChangedFromComponent(string filePath)
    {
        if (!string.IsNullOrEmpty(filePath))
        {
            SelectedSourceXml = filePath;

            // Extract project from file path
            // Path format: /app/data/input/{customer}/projects/{projectId}/file.xml
            // or: /app/data/output/{customer}/projects/{projectId}/file.xml
            var match = System.Text.RegularExpressions.Regex.Match(
                filePath,
                @"/app/data/(input|output)/([^/]+)/projects/([^/]+)/"
            );

            if (match.Success)
            {
                var customer = match.Groups[2].Value;
                var projectId = match.Groups[3].Value;
                SelectedProject = $"{customer}/{projectId}";
                Logger.LogInformation("Auto-selected project from file path: {Project}", SelectedProject);

                // Save project selection
                await UserSelectionService.UpdateSelectionAsync(projectId: SelectedProject);
                Logger.LogInformation("Saved project selection: {Project}", SelectedProject);
            }

            // Save source XML selection (just filename for portability)
            var filename = Path.GetFileName(filePath);
            await UserSelectionService.UpdateSelectionAsync(sourceXml: filename);
            Logger.LogInformation("Saved source XML selection: {File}", filename);

            await OnSourceXmlChangedAsync();
            LoadHierarchyXmlFiles();
        }
    }

    private void LoadHierarchyXmlFiles()
    {
        HierarchyXmlFiles.Clear();
        SelectedHierarchyXml = null;

        if (string.IsNullOrEmpty(SelectedSourceXml))
            return;

        // Extract project directory from source XML path
        // e.g., /app/data/input/taxxor/projects/ar25-1/docling-output.xml
        // -> /app/data/input/taxxor/projects/ar25-1
        var projectDir = Path.GetDirectoryName(SelectedSourceXml);
        if (string.IsNullOrEmpty(projectDir))
            return;

        var metadataDir = Path.Combine(projectDir, "metadata");
        if (!Directory.Exists(metadataDir))
            return;

        // Get all XML files in metadata folder
        HierarchyXmlFiles = Directory.GetFiles(metadataDir, "*.xml")
            .OrderBy(f => Path.GetFileName(f))
            .ToList();

        Logger.LogInformation("Found {Count} hierarchy XML files in {Dir}", HierarchyXmlFiles.Count, metadataDir);

        // Force Blazor to re-render the dropdown
        StateHasChanged();
    }

    private async Task OnHierarchyXmlChangedAsync()
    {
        if (!string.IsNullOrEmpty(SelectedHierarchyXml))
        {
            // Save to user selections (save just the filename for portability)
            var filename = Path.GetFileName(SelectedHierarchyXml);
            await UserSelectionService.UpdateSelectionAsync(hierarchyXml: filename);
            Logger.LogInformation("Saved hierarchy XML selection: {File}", filename);

            await LoadExistingHierarchyAsync();
        }
    }

    // Alert state
    private string? AlertMessage { get; set; }
    private string AlertType { get; set; } = "info"; // success, warning, danger, info

    // File paths for the headers panel - dynamic based on selection
    private string? NormalizedXmlPath { get; set; }
    private string? HierarchyXmlPath
    {
        get
        {
            if (string.IsNullOrEmpty(SelectedProject)) return null;
            var parts = SelectedProject.Split('/');
            if (parts.Length != 2) return null;
            return $"/app/data/output/{parts[0]}/projects/{parts[1]}/hierarchy.xml";
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("[OnInitializedAsync] Starting initialization");

        try
        {
            // Check Ollama health on page load
            try
            {
                var models = await OllamaService.GetAvailableModelsAsync();
                _ollamaHealthy = models?.Any() ?? false;
            }
            catch
            {
                _ollamaHealthy = false;
            }

            // Load all projects
            Projects = await ProjectLabelService.GetAllProjectsAsync("/app/data/input");
            Logger.LogInformation("[OnInitializedAsync] Loaded {Count} projects", Projects.Count);

            // Try to restore last selection
            var selection = await UserSelectionService.GetSelectionAsync();
            if (selection != null)
            {
                Logger.LogInformation("[OnInitializedAsync] Found user selections");

                // Restore project selection
                if (!string.IsNullOrEmpty(selection.LastSelectedProject))
                {
                    SelectedProject = selection.LastSelectedProject;
                    Logger.LogInformation("[OnInitializedAsync] Restored project: {Project}", SelectedProject);
                }

                // Restore source XML if available - reconstruct full path
                if (!string.IsNullOrEmpty(selection.LastSelectedSourceXml) && !string.IsNullOrEmpty(SelectedProject))
                {
                    var sourceXmlFilename = selection.LastSelectedSourceXml;
                    var parts = SelectedProject.Split('/');
                    if (parts.Length == 2)
                    {
                        var customer = parts[0];
                        var projectId = parts[1];

                        // Try input directory first
                        var inputPath = $"/app/data/input/{customer}/projects/{projectId}/{sourceXmlFilename}";
                        if (File.Exists(inputPath))
                        {
                            SelectedSourceXml = inputPath;
                            Logger.LogInformation("[OnInitializedAsync] Restored source XML from input: {File}", SelectedSourceXml);
                        }
                        else
                        {
                            // Try output directory as fallback
                            var outputPath = $"/app/data/output/{customer}/projects/{projectId}/{sourceXmlFilename}";
                            if (File.Exists(outputPath))
                            {
                                SelectedSourceXml = outputPath;
                                Logger.LogInformation("[OnInitializedAsync] Restored source XML from output: {File}", SelectedSourceXml);
                            }
                            else
                            {
                                Logger.LogWarning("[OnInitializedAsync] Source XML file not found: {File}", sourceXmlFilename);
                            }
                        }
                    }
                }

                // Restore XSLT selection
                if (!string.IsNullOrEmpty(selection.LastSelectedXslt))
                {
                    SelectedXsltFile = selection.LastSelectedXslt;
                    Logger.LogInformation("[OnInitializedAsync] Restored XSLT: {File}", SelectedXsltFile);
                }

                // If source XML was restored, load hierarchy files and transform
                if (!string.IsNullOrEmpty(SelectedSourceXml))
                {
                    // Load hierarchy XML files from metadata folder
                    LoadHierarchyXmlFiles();

                    // Auto-transform and load if XSLT is available
                    if (!string.IsNullOrEmpty(SelectedXsltFile))
                    {
                        await AutoTransformAndLoadAsync();
                    }

                    // Restore hierarchy XML selection if available
                    if (!string.IsNullOrEmpty(selection.LastSelectedHierarchyXml))
                    {
                        var hierarchyFilename = selection.LastSelectedHierarchyXml;

                        // Find matching file in HierarchyXmlFiles list
                        var matchingFile = HierarchyXmlFiles.FirstOrDefault(f =>
                            Path.GetFileName(f).Equals(hierarchyFilename, StringComparison.OrdinalIgnoreCase));

                        if (matchingFile != null)
                        {
                            SelectedHierarchyXml = matchingFile;
                            Logger.LogInformation("[OnInitializedAsync] Restored hierarchy XML: {File}", matchingFile);

                            // Auto-load the hierarchy
                            await OnHierarchyXmlChangedAsync();
                        }
                        else
                        {
                            Logger.LogWarning("[OnInitializedAsync] Hierarchy file not found: {File}", hierarchyFilename);
                        }
                    }
                }
                else
                {
                    Logger.LogInformation("[OnInitializedAsync] No source XML to restore");
                }
            }
            else
            {
                Logger.LogWarning("[OnInitializedAsync] No user selections found");
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[OnInitializedAsync] Error during initialization");
            ToastNotification.ShowError($"Initialization error: {ex.Message}");
        }
    }

    private async Task OnSourceXmlChangedAsync()
    {
        try
        {
            if (!string.IsNullOrEmpty(SelectedSourceXml))
            {
                // Save only the filename for consistency with Transform page
                var filename = Path.GetFileName(SelectedSourceXml);
                await UserSelectionService.UpdateSelectionAsync(sourceXml: filename);
                await AutoTransformAndLoadAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating source XML selection");
            ShowAlert("danger", $"Error: {ex.Message}");
        }
    }

    private async Task LoadDocumentAsync(bool showToast = true)
    {
        if (string.IsNullOrEmpty(SelectedSourceXml)) return;

        IsLoadingDocument = true;
        try
        {
            // Warn if unsaved changes
            if (HasChanges && CurrentHierarchy != null)
            {
                // TODO: Show confirmation dialog
                Logger.LogWarning("Loading new document with unsaved changes");
            }

            // Clear current hierarchy
            CurrentHierarchy = null;
            HasChanges = false;

            // Load headers - pass paths explicitly to avoid parameter binding issues
            if (HeadersPanel != null)
            {
                await HeadersPanel.LoadHeadersAsync(NormalizedXmlPath, HierarchyXmlPath);
            }

            // Success toast removed - user can see document loaded by headers appearing
            Logger.LogInformation("Loaded document headers from {Path}", SelectedSourceXml);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load document");
            ToastNotification.ShowError($"Failed to load document: {ex.Message}");
        }
        finally
        {
            IsLoadingDocument = false;
        }
    }

    private async Task LoadExistingHierarchyAsync()
    {
        if (string.IsNullOrEmpty(SelectedHierarchyXml))
        {
            Logger.LogWarning("No hierarchy XML file selected");
            return;
        }

        IsLoadingHierarchy = true;
        try
        {
            if (!File.Exists(SelectedHierarchyXml))
            {
                ToastNotification.ShowError($"Hierarchy file not found: {Path.GetFileName(SelectedHierarchyXml)}");
                Logger.LogError("Hierarchy file not found: {Path}", SelectedHierarchyXml);
                return;
            }

            CurrentHierarchy = await HierarchyService.LoadHierarchyAsync(SelectedHierarchyXml);
            HasChanges = false;
            _isAiGenerated = false;  // Manual hierarchies are not AI-generated
            _validationResult = null;  // Clear validation result for manually loaded hierarchies
            Logger.LogInformation("Loaded hierarchy from {Path}", SelectedHierarchyXml);
            // Success toast removed - user can see hierarchy loaded in the UI

            // Refresh headers panel to mark used headers - pass paths explicitly
            if (HeadersPanel != null)
            {
                await HeadersPanel.LoadHeadersAsync(NormalizedXmlPath, HierarchyXmlPath);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load hierarchy");
            ToastNotification.ShowError($"Failed to load hierarchy: {ex.Message}");
        }
        finally
        {
            IsLoadingHierarchy = false;
        }
    }

    private async Task SaveHierarchyAsync()
    {
        if (CurrentHierarchy == null || string.IsNullOrEmpty(SelectedProject))
        {
            ToastNotification.ShowError("No hierarchy to save or no project selected");
            return;
        }

        try
        {
            string filePath;

            // AI-generated hierarchies go to metadata folder with specific name
            if (_isAiGenerated)
            {
                var parts = SelectedProject.Split('/');
                if (parts.Length != 2)
                {
                    Logger.LogError("Invalid project format: {Project}", SelectedProject);
                    ToastNotification.ShowError("Invalid project format");
                    return;
                }

                var customer = parts[0];
                var projectId = parts[1];
                var metadataDir = $"/app/data/input/{customer}/projects/{projectId}/metadata";

                // Ensure metadata directory exists
                if (!Directory.Exists(metadataDir))
                {
                    Directory.CreateDirectory(metadataDir);
                    Logger.LogInformation("Created metadata directory: {Dir}", metadataDir);
                }

                filePath = Path.Combine(metadataDir, "ai-hierarchy.xml");
                Logger.LogInformation("Saving AI-generated hierarchy to metadata folder: {Path}", filePath);
            }
            else if (!string.IsNullOrEmpty(SelectedHierarchyXml))
            {
                // Save back to the selected hierarchy file
                filePath = SelectedHierarchyXml;
            }
            else
            {
                // Fallback to default hierarchy.xml location in output folder
                var parts = SelectedProject.Split('/');
                if (parts.Length != 2)
                {
                    Logger.LogError("Invalid project format: {Project}", SelectedProject);
                    ToastNotification.ShowError("Invalid project format");
                    return;
                }

                var customer = parts[0];
                var projectId = parts[1];
                filePath = $"/app/data/output/{customer}/projects/{projectId}/hierarchy.xml";
            }

            await HierarchyService.SaveHierarchyAsync(filePath, CurrentHierarchy);
            HasChanges = false;
            Logger.LogInformation("Saved hierarchy to {Path}", filePath);
            // Success toast removed - HasChanges = false indicates save success

            // Refresh headers panel to update used status
            if (HeadersPanel != null)
            {
                await HeadersPanel.RefreshUsedStatusAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save hierarchy");
            ToastNotification.ShowError($"Failed to save hierarchy: {ex.Message}");
        }
    }

    private void HandleItemSelected(HierarchyItem item)
    {
        SelectedItem = item;
    }

    private void HandleItemEdited(HierarchyItem item)
    {
        HasChanges = true;
    }

    private void HandleEditRequest(HierarchyItem item)
    {
        EditingItem = item;
        StateHasChanged();
    }

    private async Task HandleItemUpdated(HierarchyItem updatedItem)
    {
        // Item is already updated by reference, just mark as changed
        HasChanges = true;
        EditingItem = null;
        StateHasChanged();

        // Optionally refresh the headers panel to reflect changes
        if (HeadersPanel != null)
        {
            await HeadersPanel.RefreshUsedStatusAsync();
        }
    }

    private void CloseEditor()
    {
        EditingItem = null;
        StateHasChanged();
    }

    private async Task HandleHeadersChanged()
    {
        // Called when headers are loaded/refreshed
        StateHasChanged();
    }

    private string GetConfidenceColor(int confidence)
    {
        return confidence >= 80 ? "success" : confidence >= 70 ? "warning" : "danger";
    }

    private async Task AutoTransformAndLoadAsync()
    {
        if (string.IsNullOrEmpty(SelectedSourceXml) || string.IsNullOrEmpty(SelectedXsltFile))
        {
            if (string.IsNullOrEmpty(SelectedXsltFile))
            {
                ShowAlert("warning", "No XSLT file selected. Please transform a document on the Transform page first.");
            }
            return;
        }

        IsLoadingDocument = true;
        ClearAlert();

        try
        {
            // Warn if unsaved changes
            if (HasChanges && CurrentHierarchy != null)
            {
                Logger.LogWarning("Loading new document with unsaved changes");
            }

            // Clear current hierarchy
            CurrentHierarchy = null;
            HasChanges = false;

            // Read source XML
            var xmlContent = await File.ReadAllTextAsync(SelectedSourceXml);

            // Read XSLT
            var xsltPath = $"/app/xslt/{SelectedXsltFile}";
            if (!File.Exists(xsltPath))
            {
                ShowAlert("danger", $"XSLT file not found: {SelectedXsltFile}");
                return;
            }
            var xsltContent = await File.ReadAllTextAsync(xsltPath);

            // Transform
            Logger.LogInformation("Transforming {SourceXml} with {Xslt}", Path.GetFileName(SelectedSourceXml), SelectedXsltFile);
            var transformResult = await XsltTransformationService.TransformAsync(
                xmlContent,
                xsltContent,
                new TransformationOptions
                {
                    UseXslt3Service = true,
                    NormalizeHeaders = false
                },
                xsltPath  // Pass file path for module resolution
            );

            if (!transformResult.IsSuccess)
            {
                ShowAlert("danger", $"Transformation failed: {transformResult.ErrorMessage}");
                Logger.LogError("Transformation failed: {Error}", transformResult.ErrorMessage);
                return;
            }

            // Save transformed XML to normalized location
            var parts = SelectedProject?.Split('/');
            if (parts?.Length == 2)
            {
                var customer = parts[0];
                var projectId = parts[1];
                var normalizedPath = $"/app/data/output/{customer}/projects/{projectId}/normalized.xml";
                var normalizedDir = Path.GetDirectoryName(normalizedPath);
                if (!Directory.Exists(normalizedDir))
                {
                    Directory.CreateDirectory(normalizedDir!);
                }
                await File.WriteAllTextAsync(normalizedPath, transformResult.OutputContent);
                NormalizedXmlPath = normalizedPath;
                Logger.LogInformation("Saved normalized XML to {Path}", normalizedPath);
                Logger.LogInformation("NormalizedXmlPath set to: {Path}, File exists: {Exists}",
                    NormalizedXmlPath, File.Exists(NormalizedXmlPath));
            }

            // Load headers by passing the path directly (before parameter binding completes)
            Logger.LogInformation("About to load headers. HeadersPanel is null: {IsNull}, NormalizedXmlPath: {Path}",
                HeadersPanel == null, NormalizedXmlPath);

            if (HeadersPanel != null && !string.IsNullOrEmpty(NormalizedXmlPath))
            {
                await HeadersPanel.LoadHeadersAsync(NormalizedXmlPath, HierarchyXmlPath);
                Logger.LogInformation("Headers loaded. AllHeaders count from panel should be visible in AvailableHeadersPanel logs");
            }
            else
            {
                Logger.LogWarning("HeadersPanel is null or NormalizedXmlPath is empty, cannot load headers");
            }

            // Only log success - no toast (user can see document loaded by headers appearing)
            Logger.LogInformation("Successfully transformed and loaded document: {FileName}",
                Path.GetFileName(SelectedSourceXml));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Auto-transform failed");
            ShowAlert("danger", $"Transformation error: {ex.Message}");
        }
        finally
        {
            IsLoadingDocument = false;
        }
    }

    private void ShowAlert(string type, string message)
    {
        AlertType = type;
        AlertMessage = message;
        StateHasChanged();
    }

    private void ClearAlert()
    {
        AlertMessage = null;
    }

    // AI Generation Methods

    private async Task ShowAiGenerationModal()
    {
        _aiError = null;
        _showAiModal = true;

        // Load XSLT files
        LoadXsltFiles();

        // Load Ollama models and training hierarchies
        await LoadOllamaModelsAsync();
        LoadTrainingHierarchies();

        // Restore training hierarchy selections from user preferences
        var selection = await UserSelectionService.GetSelectionAsync();
        if (selection?.LastSelectedTrainingHierarchies != null && selection.LastSelectedTrainingHierarchies.Any())
        {
            RestoreTrainingSelections(selection.LastSelectedTrainingHierarchies);
            Logger.LogInformation("Restored {Count} training hierarchy selections", selection.LastSelectedTrainingHierarchies.Count);
        }

        StateHasChanged();
    }

    private void CloseAiModal()
    {
        _showAiModal = false;
        _aiError = null;
        StateHasChanged();
    }

    private void LoadXsltFiles()
    {
        try
        {
            var xsltDir = "/app/xslt";
            if (Directory.Exists(xsltDir))
            {
                _availableXsltFiles = Directory.GetFiles(xsltDir, "*.xslt", SearchOption.AllDirectories)
                    .OrderBy(f => f)
                    .ToList();

                // Smart default selection based on source XML filename
                string? defaultXslt = null;

                // Check if source XML filename contains "docling"
                if (!string.IsNullOrEmpty(SelectedSourceXml))
                {
                    var sourceFileName = Path.GetFileName(SelectedSourceXml).ToLowerInvariant();
                    if (sourceFileName.Contains("docling"))
                    {
                        // Select docling transformation
                        defaultXslt = _availableXsltFiles.FirstOrDefault(f => f.Contains("docling/transformation.xslt"));
                        Logger.LogInformation("Source XML contains 'docling', defaulting to docling/transformation.xslt");
                    }
                    else
                    {
                        // Select adobe transformation
                        defaultXslt = _availableXsltFiles.FirstOrDefault(f => f.Contains("adobe/transformation.xslt"));
                        Logger.LogInformation("Source XML does not contain 'docling', defaulting to adobe/transformation.xslt");
                    }
                }

                // Fallback: use any transformation.xslt if smart selection didn't find anything
                if (string.IsNullOrEmpty(defaultXslt))
                {
                    defaultXslt = _availableXsltFiles.FirstOrDefault(f => f.Contains("transformation.xslt"));
                }

                // Final fallback: use first available XSLT
                _selectedAiXslt = defaultXslt ?? _availableXsltFiles.FirstOrDefault() ?? string.Empty;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load XSLT files");
        }
    }

    private async Task LoadOllamaModelsAsync()
    {
        try
        {
            _availableAiModels = await OllamaService.GetAvailableModelsAsync();
            _ollamaHealthy = _availableAiModels.Any();

            if (!_ollamaHealthy)
            {
                _aiError = "Ollama service is not running or has no models installed.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load Ollama models");
            _aiError = "Failed to connect to Ollama service.";
            _ollamaHealthy = false;
        }
    }

    private void LoadTrainingHierarchies()
    {
        try
        {
            var trainingDir = "/app/data/training-material/hierarchies";

            if (!Directory.Exists(trainingDir))
            {
                Logger.LogWarning("Training material hierarchies directory not found: {Dir}", trainingDir);
                return;
            }

            var hierarchyFiles = Directory.GetFiles(trainingDir, "*.xml", SearchOption.AllDirectories)
                .OrderBy(f => f)
                .ToList();

            _exampleHierarchies = hierarchyFiles.Select(path =>
            {
                var relativePath = path.Replace(trainingDir + "/", "");
                var parts = relativePath.Split('/');
                var organization = parts.Length > 0 ? parts[0] : "unknown";
                var project = parts.Length > 1 ? parts[1] : "unknown";
                var filename = Path.GetFileName(path);

                var displayName = $"{organization}/{project} - {filename}";

                return new ExampleHierarchy
                {
                    Path = path,
                    DisplayName = displayName,
                    IsSelected = false,
                    Content = null
                };
            }).ToList();

            Logger.LogInformation("Loaded {Count} training hierarchies", _exampleHierarchies.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load training hierarchies");
            _exampleHierarchies = new List<ExampleHierarchy>();
        }
    }

    private async Task ToggleExample(ExampleHierarchy example)
    {
        example.IsSelected = !example.IsSelected;

        if (example.IsSelected && example.Content == null)
        {
            try
            {
                example.Content = File.ReadAllText(example.Path);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to load example hierarchy: {Path}", example.Path);
                example.IsSelected = false;
                _aiError = $"Failed to load example: {Path.GetFileName(example.Path)}";
            }
        }

        // Save current selections after toggle
        await UserSelectionService.UpdateSelectionAsync(trainingHierarchies: GetSelectedHierarchyPaths());
    }

    private async Task GenerateWithAi()
    {
        _isGeneratingAi = true;
        _aiError = null;

        try
        {
            // Verify we have source XML selected
            if (string.IsNullOrEmpty(SelectedSourceXml))
            {
                _aiError = "Please select a source XML file first.";
                return;
            }

            // Get selected examples
            var selectedExamples = _exampleHierarchies
                .Where(e => e.IsSelected && e.Content != null)
                .Select(e => e.Content!)
                .ToList();

            if (selectedExamples.Count == 0)
            {
                _aiError = "Please select at least one training example.";
                return;
            }

            // Validate XSLT selection
            if (string.IsNullOrEmpty(_selectedAiXslt))
            {
                _aiError = "Please select an XSLT transformation file.";
                return;
            }

            // Read and transform source XML
            var sourceXmlContent = await File.ReadAllTextAsync(SelectedSourceXml);

            // Read XSLT file
            var xsltContent = await File.ReadAllTextAsync(_selectedAiXslt);

            // Transform with proper options and file path for include resolution
            Logger.LogInformation("Transforming source XML with XSLT: {Xslt}", _selectedAiXslt);
            var transformResult = await XsltTransformationService.TransformAsync(
                sourceXmlContent,
                xsltContent,
                new TransformationOptions
                {
                    UseXslt3Service = true,
                    NormalizeHeaders = false
                },
                _selectedAiXslt  // Pass file path for module resolution
            );

            if (!transformResult.IsSuccess)
            {
                _aiError = $"XSLT transformation failed: {transformResult.ErrorMessage}";
                return;
            }

            // Generate hierarchy with AI
            Logger.LogInformation("Generating hierarchy with {ModelName} using {Count} examples",
                _selectedAiModel, selectedExamples.Count);
            var proposal = await HierarchyGenerator.GenerateHierarchyAsync(
                normalizedXml: transformResult.OutputContent,
                exampleHierarchies: selectedExamples,
                modelName: _selectedAiModel,
                cancellationToken: CancellationToken.None
            );

            // Store validation result for UI display
            _validationResult = proposal.ValidationResult;

            // Convert HierarchyProposal to HierarchyStructure and load into editor
            var hierarchyStructure = proposal.ToHierarchyStructure();
            CurrentHierarchy = hierarchyStructure;
            HasChanges = true;
            _isAiGenerated = true;  // Mark this hierarchy as AI-generated

            // Close modal
            _showAiModal = false;

            // Only show warnings/errors - no success toast
            Logger.LogInformation("AI generated hierarchy with {Count} items, confidence: {Confidence}%",
                proposal.TotalItems, proposal.OverallConfidence);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "AI hierarchy generation failed");
            _aiError = $"Generation failed: {ex.Message}";
        }
        finally
        {
            _isGeneratingAi = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Get full paths of currently selected training hierarchies
    /// </summary>
    private List<string> GetSelectedHierarchyPaths()
    {
        return _exampleHierarchies
            .Where(e => e.IsSelected)
            .Select(e => e.Path)
            .ToList();
    }

    /// <summary>
    /// Restore training hierarchy selections from saved paths
    /// </summary>
    private void RestoreTrainingSelections(List<string> paths)
    {
        foreach (var example in _exampleHierarchies)
        {
            if (paths.Contains(example.Path))
            {
                example.IsSelected = true;

                // Preload content for selected examples
                if (example.Content == null)
                {
                    try
                    {
                        example.Content = File.ReadAllText(example.Path);
                    }
                    catch (Exception ex)
                    {
                        Logger.LogError(ex, "Failed to load saved training hierarchy: {Path}", example.Path);
                        example.IsSelected = false;
                    }
                }
            }
        }
    }
}
