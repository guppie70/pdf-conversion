@page "/docling-convert"
@using System.Net.Http.Headers
@using PdfConversion.Services
@using PdfConversion.Models
@inject IProjectLabelService ProjectLabelService
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ILogger<DoclingConvert> Logger

<PageTitle>Docling Convert - Step 1</PageTitle>

<div class="docling-convert-container">
    <div class="docling-header">
        <h3>Docling Convert - Step 1</h3>
        <p class="text-muted">Upload PDF or Word files and convert them to DocBook XML using Docling</p>
    </div>

    <!-- Configuration Panel -->
    <div class="docling-panel">
        <div class="panel-header">
            <h5>Configuration</h5>
        </div>
        <div class="panel-body">
            <!-- Project Selection -->
            <div class="form-group">
                <label for="projectSelect" class="form-label">Project</label>
                <select id="projectSelect"
                        class="form-select"
                        @bind="SelectedProject"
                        disabled="@IsConverting">
                    <option value="">-- Select Project --</option>
                    @foreach (var project in Projects)
                    {
                        <option value="@project.ProjectId">@project.DisplayString</option>
                    }
                </select>
            </div>

            <!-- File Upload Area -->
            <div class="form-group mt-3">
                <label class="form-label">Document File</label>
                <div class="upload-area @(IsDragging ? "dragging" : "")"
                     @ondragenter="HandleDragEnter"
                     @ondragleave="HandleDragLeave"
                     @ondragover:preventDefault
                     @ondrop="HandleDrop"
                     @ondrop:preventDefault>

                    @if (UploadedFile == null)
                    {
                        <div class="upload-prompt">
                            <i class="bi bi-cloud-arrow-up" style="font-size: 3rem; color: #0d6efd;"></i>
                            <p class="mt-3 mb-2"><strong>Drag & drop PDF or Word file here</strong></p>
                            <p class="text-muted small">or click to browse</p>
                            <p class="text-muted small">Supported: PDF, DOCX, DOC (max 50MB)</p>
                            <InputFile OnChange="HandleFileSelect" accept=".pdf,.docx,.doc" class="d-none" id="fileInput" />
                            <button type="button" class="btn btn-primary mt-2" @onclick="OpenFileDialog">
                                Browse Files
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="file-info">
                            <i class="bi bi-file-earmark-check" style="font-size: 2rem; color: #28a745;"></i>
                            <div class="file-details mt-2">
                                <p class="mb-1"><strong>@UploadedFile.Name</strong></p>
                                <p class="text-muted mb-0">Size: @FormatFileSize(UploadedFile.Size)</p>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm mt-2" @onclick="ClearFile">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        </div>
                    }
                </div>
            </div>

            <!-- Output Format -->
            <div class="form-group mt-3">
                <label for="formatSelect" class="form-label">Output Format</label>
                <select id="formatSelect"
                        class="form-select"
                        @bind="OutputFormat"
                        disabled="@IsConverting">
                    <option value="docbook">DocBook XML</option>
                    <option value="html">HTML</option>
                    <option value="markdown">Markdown</option>
                </select>
            </div>

            <!-- Convert Button -->
            <div class="button-group mt-3">
                <button class="btn btn-primary"
                        @onclick="ConvertWithDocling"
                        disabled="@(!IsReadyToConvert || IsConverting)">
                    @if (IsConverting)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <span>Converting... (@ElapsedSeconds seconds)</span>
                    }
                    else
                    {
                        <i class="bi bi-play-circle"></i>
                        <span> Convert with Docling</span>
                    }
                </button>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger mt-3" role="alert">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Error:</strong> @ErrorMessage
            @if (ShowFallbackOption)
            {
                <div class="mt-2">
                    <button class="btn btn-outline-primary btn-sm" @onclick="NavigateToTransform">
                        <i class="bi bi-arrow-right-circle"></i> Use Adobe XML Pipeline Instead
                    </button>
                </div>
            }
        </div>
    }

    <!-- Success Message -->
    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="alert alert-success mt-3" role="alert">
            <i class="bi bi-check-circle"></i>
            <strong>Success:</strong> @SuccessMessage
        </div>
    }

    <!-- Preview Area -->
    @if (!string.IsNullOrEmpty(DoclingOutput))
    {
        <div class="docling-panel mt-3">
            <div class="panel-header">
                <h5>Conversion Output</h5>
            </div>
            <div class="panel-body">
                <div id="monacoPreviewContainer" class="monaco-container"></div>
                <div class="button-group mt-3">
                    <button class="btn btn-success" @onclick="SaveToProject">
                        <i class="bi bi-save"></i> Save to Project
                    </button>
                    <button class="btn btn-primary" @onclick="NavigateToTransform">
                        <i class="bi bi-arrow-right-circle"></i> Next: Transform
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    // State
    private List<ProjectInfo> Projects { get; set; } = new();
    private string SelectedProject { get; set; } = string.Empty;
    private IBrowserFile? UploadedFile { get; set; }
    private string OutputFormat { get; set; } = "docbook";
    private bool IsDragging { get; set; }
    private bool IsConverting { get; set; }
    private int ElapsedSeconds { get; set; }
    private string DoclingOutput { get; set; } = string.Empty;
    private string ErrorMessage { get; set; } = string.Empty;
    private string SuccessMessage { get; set; } = string.Empty;
    private bool ShowFallbackOption { get; set; }

    private System.Timers.Timer? _conversionTimer;
    private bool _monacoInitialized = false;

    private bool IsReadyToConvert => !string.IsNullOrEmpty(SelectedProject) && UploadedFile != null;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadProjectsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing DoclingConvert page");
            ErrorMessage = $"Failed to load projects: {ex.Message}";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!string.IsNullOrEmpty(DoclingOutput) && !_monacoInitialized)
        {
            try
            {
                await InitializeMonacoEditor();
                _monacoInitialized = true;
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error initializing Monaco editor");
            }
        }
    }

    private async Task LoadProjectsAsync()
    {
        try
        {
            var projects = await ProjectLabelService.GetAllProjectsAsync("/app/data/input");
            Projects = projects.OrderBy(p => p.Customer).ThenBy(p => p.ProjectId).ToList();
            Logger.LogInformation($"Loaded {Projects.Count} projects");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading projects");
            throw;
        }
    }

    private async Task OpenFileDialog()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('fileInput').click()");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error opening file dialog");
        }
    }

    private void HandleDragEnter()
    {
        IsDragging = true;
    }

    private void HandleDragLeave()
    {
        IsDragging = false;
    }

    private void HandleDrop()
    {
        IsDragging = false;
    }

    private void HandleFileSelect(InputFileChangeEventArgs e)
    {
        UploadedFile = e.File;
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
        Logger.LogInformation($"File selected: {UploadedFile.Name} ({FormatFileSize(UploadedFile.Size)})");
    }

    private void ClearFile()
    {
        UploadedFile = null;
        DoclingOutput = string.Empty;
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
        _monacoInitialized = false;
    }

    private async Task ConvertWithDocling()
    {
        if (UploadedFile == null || string.IsNullOrEmpty(SelectedProject))
            return;

        IsConverting = true;
        ElapsedSeconds = 0;
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
        ShowFallbackOption = false;
        DoclingOutput = string.Empty;
        _monacoInitialized = false;

        // Start timer
        _conversionTimer = new System.Timers.Timer(1000);
        _conversionTimer.Elapsed += (s, e) =>
        {
            ElapsedSeconds++;
            InvokeAsync(StateHasChanged);
        };
        _conversionTimer.Start();

        try
        {
            Logger.LogInformation($"Starting conversion: project={SelectedProject}, file={UploadedFile.Name}, format={OutputFormat}");

            // Prepare multipart form data
            using var content = new MultipartFormDataContent();

            var fileContent = new StreamContent(UploadedFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024));
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(UploadedFile.ContentType);
            content.Add(fileContent, "file", UploadedFile.Name);
            content.Add(new StringContent(SelectedProject), "project_id");
            content.Add(new StringContent(OutputFormat), "output_format");

            // Call Docling service
            var response = await Http.PostAsync("http://localhost:4808/convert", content);

            _conversionTimer?.Stop();

            if (response.IsSuccessStatusCode)
            {
                DoclingOutput = await response.Content.ReadAsStringAsync();
                SuccessMessage = $"Conversion successful! Processed in {ElapsedSeconds} seconds.";
                Logger.LogInformation($"Conversion successful: {DoclingOutput.Length} bytes");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                ErrorMessage = $"Conversion failed: {error}";
                Logger.LogError($"Conversion failed: HTTP {response.StatusCode} - {error}");

                if (response.StatusCode == System.Net.HttpStatusCode.ServiceUnavailable)
                {
                    ShowFallbackOption = true;
                }
            }
        }
        catch (HttpRequestException ex)
        {
            _conversionTimer?.Stop();
            ErrorMessage = $"Connection error: Unable to reach Docling service at http://localhost:4808. {ex.Message}";
            ShowFallbackOption = true;
            Logger.LogError(ex, "HTTP request error calling Docling service");
        }
        catch (Exception ex)
        {
            _conversionTimer?.Stop();
            ErrorMessage = $"Unexpected error: {ex.Message}";
            ShowFallbackOption = true;
            Logger.LogError(ex, "Error during Docling conversion");
        }
        finally
        {
            IsConverting = false;
            _conversionTimer?.Dispose();
            _conversionTimer = null;
        }
    }

    private async Task InitializeMonacoEditor()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync(
                "eval",
                @"
                if (typeof monaco !== 'undefined') {
                    const container = document.getElementById('monacoPreviewContainer');
                    if (container) {
                        const editor = monaco.editor.create(container, {
                            value: " + System.Text.Json.JsonSerializer.Serialize(DoclingOutput) + @",
                            language: 'xml',
                            theme: 'vs-dark',
                            readOnly: true,
                            automaticLayout: true,
                            minimap: { enabled: true },
                            scrollBeyondLastLine: false,
                            fontSize: 13,
                            lineNumbers: 'on',
                            wordWrap: 'on'
                        });
                    }
                }
                "
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing Monaco editor");
        }
    }

    private async Task SaveToProject()
    {
        try
        {
            if (string.IsNullOrEmpty(DoclingOutput) || string.IsNullOrEmpty(SelectedProject))
                return;

            var project = Projects.FirstOrDefault(p => p.ProjectId == SelectedProject);
            if (project == null)
            {
                ErrorMessage = "Selected project not found";
                return;
            }

            var outputPath = Path.Combine(project.FolderPath, "docling-output.xml");
            await File.WriteAllTextAsync(outputPath, DoclingOutput);

            SuccessMessage = $"Saved to {outputPath}";
            Logger.LogInformation($"Saved DocBook output to {outputPath}");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Save failed: {ex.Message}";
            Logger.LogError(ex, "Error saving DocBook output");
        }
    }

    private void NavigateToTransform()
    {
        Navigation.NavigateTo("/development");
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    public void Dispose()
    {
        _conversionTimer?.Stop();
        _conversionTimer?.Dispose();
    }
}
