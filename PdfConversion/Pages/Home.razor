@page "/"
@using PdfConversion.Services
@using PdfConversion.Models
@inject IProjectLabelService ProjectLabelService
@inject IProjectDirectoryWatcherService ProjectDirectoryWatcherService
@inject ProjectMetadataService MetadataService
@inject IXslt3ServiceClient Xslt3Client
@inject IOllamaService OllamaService
@inject IProjectDeletionService ProjectDeletionService
@inject IPatternReindexingService PatternReindexingService
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject ILogger<Home> Logger
@implements IDisposable

<PageTitle>Projects</PageTitle>

<div class="home-container">
    <div class="home-header">
        <div class="header-left">
            <h1>Projects</h1>
            @if (LastUpdated.HasValue)
            {
                <p class="last-updated">
                    <i class="bi bi-clock"></i> Last updated: @GetTimeAgo(LastUpdated.Value)
                </p>
            }
        </div>
        <div class="header-right">
            <button class="btn-add-project" @onclick="ShowAddProjectModal" aria-label="Add Project" title="Add Project">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            @if (IsLoading)
            {
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading projects...</span>
                    </div>
                    <p>Loading projects...</p>
                </div>
            }
            else if (ErrorMessage != null)
            {
                <div class="alert alert-danger" role="alert">
                    <i class="oi oi-warning"></i> <strong>Error:</strong> @ErrorMessage
                </div>
            }
            else if (!ProjectsByCustomer.Any())
            {
                <div class="empty-state">
                    <i class="oi oi-folder" style="font-size: 3rem;"></i>
                    <p>No projects found. Add project folders to <code>data/input/{customer}/projects/</code> to get started.</p>
                </div>
            }
            else
            {
                @foreach (var customerGroup in ProjectsByCustomer.OrderBy(g => g.Key))
                {
                    <div class="customer-section">
                        <div class="customer-header">
                            <h2>Customer: @customerGroup.Key</h2>
                            <span class="project-count">@customerGroup.Value.Count @(customerGroup.Value.Count == 1 ? "project" : "projects")</span>
                        </div>

                        <div class="table-responsive">
                            <table class="projects-table table-sm">
                                <thead>
                                    <tr>
                                        <th class="col-project-id">Project ID</th>
                                        <th class="col-display">Project Name</th>
                                        <th class="col-status">Status</th>
                                        <th class="col-actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var project in SortProjects(customerGroup.Value))
                                    {
                                        var editKey = GetEditKey(project.Customer, project.ProjectId);
                                        var statusKey = GetStatusKey(project.Customer, project.ProjectId);
                                        var isEditing = IsEditing(editKey);
                                        var isEditingStatus = IsEditingStatus(statusKey);
                                        var projectStatus = GetProjectStatus(project.Customer, project.ProjectId);

                                        <tr class="project-row status-@projectStatus.ToString().ToLower()">
                                            <td class="project-id-cell col-project-id">
                                                <code>@project.ProjectId</code>
                                            </td>
                                            <td class="display-cell col-display">
                                                @if (isEditing)
                                                {
                                                    <input
                                                        @ref="editInputRef"
                                                        type="text"
                                                        class="inline-edit-input"
                                                        value="@GetEditingValue(editKey)"
                                                        @oninput="@(e => OnEditingValueChanged(editKey, e.Value?.ToString() ?? string.Empty))"
                                                        @onblur="@(() => ExitEditMode(project.Customer, project.ProjectId))"
                                                        @onkeydown="@(e => OnEditKeyDown(e, project.Customer, project.ProjectId))"
                                                    />
                                                }
                                                else
                                                {
                                                    <span
                                                        class="editable-label"
                                                        @ondblclick="@(() => EnterEditMode(project.Customer, project.ProjectId, project.CustomLabel))"
                                                        title="Double-click to edit">
                                                        @project.DisplayString
                                                    </span>
                                                }
                                            </td>
                                            <td class="status-cell col-status" @ondblclick="@(() => StartEditingStatus(project.Customer, project.ProjectId))">
                                                @if (isEditingStatus)
                                                {
                                                    <select class="status-select"
                                                            value="@projectStatus.ToString()"
                                                            @onchange="@(e => SaveStatus(project.Customer, project.ProjectId, e.Value?.ToString()))"
                                                            @onblur="@(() => CancelEditingStatus())"
                                                            @onkeydown="@(e => HandleStatusKeyDown(e))"
                                                            @ref="@statusSelectRef">
                                                        <option value="Open">Open</option>
                                                        <option value="InProgress">In Progress</option>
                                                        <option value="Ready">Ready</option>
                                                        <option value="Parked">Parked</option>
                                                    </select>
                                                }
                                                else
                                                {
                                                    <span class="status-text">@GetStatusDisplayText(projectStatus)</span>
                                                }
                                            </td>
                                            <td class="actions-cell col-actions">
                                                <button class="btn-files"
                                                        @onclick="@(() => ShowProjectFilesModal(project.Customer, project.ProjectId, project.DisplayString))"
                                                        title="Manage files">
                                                    <i class="bi bi-folder-fill"></i>
                                                </button>
                                                <button class="btn-delete"
                                                        @onclick="@(() => ShowDeleteConfirmation(project.Customer, project.ProjectId, project.DisplayString))"
                                                        title="Delete project">
                                                    <i class="bi bi-trash3-fill"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            }
        </div>

        <div class="col-lg-4">
            <!-- Sort Controls -->
            <div class="card sort-controls-card">
                <div class="card-header">
                    <h5 class="mb-0">Sort Projects</h5>
                </div>
                <div class="card-body">
                    <select id="sortOrder" class="sort-select" @bind="SelectedSortOrder" @bind:after="OnSortOrderChanged">
                        <option value="@SortOrder.LastModifiedDesc">Last Modified (Newest First)</option>
                        <option value="@SortOrder.LastModifiedAsc">Last Modified (Oldest First)</option>
                        <option value="@SortOrder.NameAsc">Name (A-Z)</option>
                        <option value="@SortOrder.NameDesc">Name (Z-A)</option>
                        <option value="@SortOrder.ProjectStatusDesc">Project Status</option>
                        <option value="@SortOrder.ProjectIdAsc">Project ID (A-Z)</option>
                        <option value="@SortOrder.ProjectIdDesc">Project ID (Z-A)</option>
                    </select>
                </div>
            </div>

            <div class="card system-status-card">
                <div class="card-header">
                    <h5 class="mb-0">System Status</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm status-table mb-0">
                        <tbody>
                            <tr>
                                <td class="info-label">Environment:</td>
                                <td class="text-end">
                                    <span class="env-value">@Environment</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <hr/>
                    <table class="table table-sm status-table mb-0">
                        <tbody>
                            <tr>
                                <td class="service-name">XSLT Service:</td>
                                <td class="text-end">
                                    @if (IsCheckingService)
                                    {
                                        <span class="badge bg-secondary">Checking...</span>
                                    }
                                    else if (ServiceStatus == ServiceConnectionStatus.Connected)
                                    {
                                        <span class="badge bg-success">‚úì</span>
                                    }
                                    else if (ServiceStatus == ServiceConnectionStatus.Error)
                                    {
                                        <span class="badge bg-warning">Error</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">üî¥ Offline</span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td class="service-name">Docling Service:</td>
                                <td class="text-end">
                                    @if (IsCheckingDoclingService)
                                    {
                                        <span class="badge bg-secondary">Checking...</span>
                                    }
                                    else if (DoclingServiceStatus == ServiceConnectionStatus.Connected)
                                    {
                                        <span class="badge bg-success">‚úì</span>
                                    }
                                    else if (DoclingServiceStatus == ServiceConnectionStatus.Error)
                                    {
                                        <span class="badge bg-warning">Error</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">üî¥ Offline</span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td class="service-name">Ollama Service:</td>
                                <td class="text-end">
                                    @if (IsCheckingOllamaService)
                                    {
                                        <span class="badge bg-secondary">Checking...</span>
                                    }
                                    else if (OllamaServiceStatus == ServiceConnectionStatus.Connected)
                                    {
                                        <span class="badge bg-success">‚úì</span>
                                    }
                                    else if (OllamaServiceStatus == ServiceConnectionStatus.Error)
                                    {
                                        <span class="badge bg-warning">Error</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">üî¥ Offline</span>
                                    }
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <hr/>
                    <table class="table table-sm status-table mb-0">
                        <tbody>
                            <tr>
                                <td class="info-label">Projects Available:</td>
                                <td class="text-end">
                                    <span class="badge bg-@(ProjectCount > 0 ? "success" : "secondary")">@ProjectCount</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card mt-4 ollama-card">
                <div class="card-header">
                    <h5 class="mb-0">Ollama (Local LLM)</h5>
                </div>
                <div class="card-body">
                    @if (OllamaServiceStatus == ServiceConnectionStatus.Connected)
                    {
                        <p class="mb-2">
                            <strong>Endpoint:</strong> <code>http://host.docker.internal:11434</code>
                        </p>

                        @if (OllamaModels != null && OllamaModels.Any())
                        {
                            <p class="mb-2"><strong>Available Models:</strong></p>
                            <table class="table table-sm models-table mb-0">
                                <tbody>
                                    @foreach (var model in OllamaModels)
                                    {
                                        <tr>
                                            <td class="text-muted">
                                                @model.Name
                                            </td>
                                            <td class="text-muted">
                                                @FormatFileSize(model.Size)
                                            </td>
                                            <td class="text-muted">
                                                @(model.Details?.ParameterSize ?? "unknown") parameters
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="alert alert-warning mb-0">
                                <p class="mb-0">
                                    ‚ö†Ô∏è No models installed. Run: <code>ollama pull llama3.1:70b</code>
                                </p>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-warning mb-0">
                            <p class="mb-2"><strong>Ollama service is not running.</strong></p>
                            <p class="mb-0">
                                To start: <code>ollama serve</code><br/>
                                To install model: <code>ollama pull llama3.1:70b</code>
                            </p>
                        </div>
                    }
                </div>
            </div>

            <div class="card mt-4 tools-card">
                <div class="card-header">
                    <h5 class="mb-0">Tools</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary w-100 mb-3"
                            @onclick="StartReindexing"
                            disabled="@IsReindexing">
                        @if (IsReindexing)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Re-indexing...</span>
                        }
                        else
                        {
                            <i class="oi oi-reload me-2"></i>
                            <span>Re-index Training Material</span>
                        }
                    </button>

                    @if (ReindexingLogs.Any())
                    {
                        <div class="reindexing-log-panel">
                            <div class="log-header">
                                <span>Progress Log</span>
                                <button class="btn-clear-log" @onclick="ClearReindexingLogs" title="Clear log">
                                    <i class="oi oi-x"></i>
                                </button>
                            </div>
                            <div class="log-content" @ref="logContainerRef">
                                @foreach (var log in ReindexingLogs)
                                {
                                    <div class="log-entry @GetLogClass(log)">@log</div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (ShowSaveNotification)
    {
        <div class="toast-notification success" @key="notificationKey">
            <i class="oi oi-check"></i>
            <span>Label saved for @SavedProjectId</span>
        </div>
    }

    @if (ShowErrorNotification)
    {
        <div class="toast-notification error" @key="notificationKey">
            <i class="oi oi-warning"></i>
            <span>Failed to save label: @NotificationError</span>
        </div>
    }

    <ConfirmationModal
        IsVisible="@showDeleteConfirmation"
        Title="Delete Project"
        Message="@deleteConfirmationMessage"
        ConfirmButtonText="Delete"
        OnConfirm="@ConfirmDelete"
        OnCancel="@CancelDelete" />

    <AddProjectModal
        IsVisible="@showAddProjectModal"
        OnProjectCreated="@OnProjectCreated"
        OnCancel="@CloseAddProjectModal" />

    <ProjectFilesModal
        IsVisible="@showProjectFilesModal"
        Customer="@selectedProjectCustomer"
        ProjectId="@selectedProjectId"
        ProjectDisplayString="@selectedProjectDisplayString"
        OnClose="@(() => CloseProjectFilesModal())"
        OnFilesUploaded="@(() => OnFilesUploaded())" />

    <ToastNotification @ref="toastNotification" />
</div>

@code {
    private enum ServiceConnectionStatus
    {
        Checking,
        Connected,
        NotConnected,
        Error
    }

    private enum SortOrder
    {
        LastModifiedDesc,
        LastModifiedAsc,
        NameAsc,
        NameDesc,
        ProjectStatusDesc,
        ProjectIdAsc,
        ProjectIdDesc
    }

    private Dictionary<string, List<ProjectInfo>> ProjectsByCustomer { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private string? ErrorMessage { get; set; }
    private DateTime? LastUpdated { get; set; }

    // Sort state
    private SortOrder SelectedSortOrder { get; set; } = SortOrder.LastModifiedDesc;
    private const string SortOrderStorageKey = "dev_projectSortOrder";

    // Edit state management
    private Dictionary<string, string> _editingProjects = new(); // key: "customer:projectId", value: current edit value
    private ElementReference editInputRef;

    // Status edit state management
    private Dictionary<string, Dictionary<string, ProjectMetadata>> _projectMetadata = new();
    private string? _editingStatusTenant;
    private string? _editingStatusProjectId;
    private ElementReference statusSelectRef;

    // Auto-save state
    private readonly Dictionary<string, System.Timers.Timer> _debounceTimers = new();
    private const int DebounceDelayMs = 500;

    // Toast notification state
    private bool ShowSaveNotification { get; set; }
    private bool ShowErrorNotification { get; set; }
    private string SavedProjectId { get; set; } = string.Empty;
    private string NotificationError { get; set; } = string.Empty;
    private int notificationKey = 0;

    // System status properties
    private string Environment => System.Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") ?? "Production";
    private int ProjectCount { get; set; } = 0;
    private ServiceConnectionStatus ServiceStatus { get; set; } = ServiceConnectionStatus.Checking;
    private bool IsCheckingService => ServiceStatus == ServiceConnectionStatus.Checking;
    private ServiceConnectionStatus DoclingServiceStatus { get; set; } = ServiceConnectionStatus.Checking;
    private bool IsCheckingDoclingService => DoclingServiceStatus == ServiceConnectionStatus.Checking;
    private ServiceConnectionStatus OllamaServiceStatus { get; set; } = ServiceConnectionStatus.Checking;
    private bool IsCheckingOllamaService => OllamaServiceStatus == ServiceConnectionStatus.Checking;
    private List<OllamaModel>? OllamaModels { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load sort order from localStorage
            await LoadSortOrderFromStorage();

            // Subscribe to project directory changes
            ProjectDirectoryWatcherService.ProjectsChanged += OnProjectsChangedAsync;

            // Start watching for directory changes
            ProjectDirectoryWatcherService.StartWatching("data/input");

            // Load project metadata FIRST (needed for merging into projects)
            _projectMetadata = await MetadataService.GetAllProjects();

            // Load initial projects (will merge metadata labels)
            await LoadProjectsAsync();

            // Check service statuses
            await CheckXsltServiceStatusAsync();
            await CheckDoclingServiceStatusAsync();
            await CheckOllamaServiceStatusAsync();

            // Set project count
            ProjectCount = ProjectsByCustomer.Values.Sum(list => list.Count);
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
            IsLoading = false;
        }
    }

    private async Task CheckXsltServiceStatusAsync()
    {
        try
        {
            ServiceStatus = ServiceConnectionStatus.Checking;
            var isAvailable = await Xslt3Client.IsServiceAvailableAsync();
            ServiceStatus = isAvailable ? ServiceConnectionStatus.Connected : ServiceConnectionStatus.NotConnected;
        }
        catch (Exception)
        {
            ServiceStatus = ServiceConnectionStatus.Error;
        }
    }

    private async Task CheckDoclingServiceStatusAsync()
    {
        try
        {
            DoclingServiceStatus = ServiceConnectionStatus.Checking;
            var response = await Http.GetAsync("http://docling-service:4808/health");
            DoclingServiceStatus = response.IsSuccessStatusCode ? ServiceConnectionStatus.Connected : ServiceConnectionStatus.NotConnected;
        }
        catch (Exception)
        {
            DoclingServiceStatus = ServiceConnectionStatus.NotConnected;
        }
    }

    private async Task CheckOllamaServiceStatusAsync()
    {
        try
        {
            OllamaServiceStatus = ServiceConnectionStatus.Checking;
            StateHasChanged();

            var isHealthy = await OllamaService.CheckHealthAsync();

            if (isHealthy)
            {
                try
                {
                    OllamaModels = await OllamaService.GetAvailableModelsAsync();
                    OllamaServiceStatus = ServiceConnectionStatus.Connected;
                    Console.WriteLine($"[Home.razor] Ollama connected, {OllamaModels.Count} models found");
                }
                catch (Exception ex)
                {
                    // Service is up but couldn't get models
                    OllamaModels = new List<OllamaModel>();
                    OllamaServiceStatus = ServiceConnectionStatus.Connected;
                    Console.WriteLine($"[Home.razor] Could not fetch Ollama models: {ex.Message}");
                }
            }
            else
            {
                OllamaModels = null;
                OllamaServiceStatus = ServiceConnectionStatus.NotConnected;
                Console.WriteLine("[Home.razor] Ollama service not connected");
            }
        }
        catch (Exception ex)
        {
            OllamaModels = null;
            OllamaServiceStatus = ServiceConnectionStatus.Error;
            Console.WriteLine($"[Home.razor] Ollama health check failed: {ex.Message}");
        }
    }

    private async Task LoadProjectsAsync()
    {
        try
        {
            Console.WriteLine($"[Home.razor] LoadProjectsAsync started at {DateTime.Now:HH:mm:ss.fff}");
            IsLoading = true;
            ErrorMessage = null;

            var projects = await ProjectLabelService.GetAllProjectsAsync("data/input");
            Console.WriteLine($"[Home.razor] Loaded {projects.Count} projects from service");

            // Merge custom labels from metadata into projects
            foreach (var project in projects)
            {
                if (_projectMetadata.TryGetValue(project.Customer, out var tenantProjects))
                {
                    if (tenantProjects.TryGetValue(project.ProjectId, out var metadata))
                    {
                        project.CustomLabel = metadata.Label;
                        // Update DisplayString to reflect the custom label
                        project.DisplayString = !string.IsNullOrWhiteSpace(metadata.Label)
                            ? $"{metadata.Label} ({project.ProjectId})"
                            : project.ProjectId;
                        Console.WriteLine($"[Home.razor] Applied custom label to {project.Customer}/{project.ProjectId}: '{metadata.Label}'");
                    }
                }
            }

            // Group by customer
            ProjectsByCustomer = projects
                .GroupBy(p => p.Customer)
                .ToDictionary(g => g.Key, g => g.ToList());

            // Log loaded project display strings for debugging
            foreach (var (customer, projectList) in ProjectsByCustomer)
            {
                foreach (var project in projectList)
                {
                    Console.WriteLine($"[Home.razor] {customer}/{project.ProjectId} -> DisplayString: '{project.DisplayString}'");
                }
            }

            LastUpdated = DateTime.Now;
            IsLoading = false;

            Console.WriteLine($"[Home.razor] LoadProjectsAsync completed, calling StateHasChanged");
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Home.razor] LoadProjectsAsync ERROR: {ex.Message}");
            ErrorMessage = $"Failed to load projects: {ex.Message}";
            IsLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OnProjectsChangedAsync(object? sender, ProjectsChangedEventArgs e)
    {
        // Reload projects when filesystem changes detected
        _ = LoadProjectsAsync();
    }

    private void OnLabelChanged(string customer, string projectId, string newLabel)
    {
        // Create a unique key for this project's timer
        var timerKey = $"{customer}:{projectId}";

        // Cancel existing timer for this project if it exists
        if (_debounceTimers.TryGetValue(timerKey, out var existingTimer))
        {
            existingTimer.Stop();
            existingTimer.Dispose();
            _debounceTimers.Remove(timerKey);
        }

        // Create new debounce timer
        var timer = new System.Timers.Timer(DebounceDelayMs);
        timer.AutoReset = false;
        timer.Elapsed += async (s, e) =>
        {
            await SaveLabelAsync(customer, projectId, newLabel);

            // Clean up timer
            timer.Dispose();
            _debounceTimers.Remove(timerKey);
        };

        _debounceTimers[timerKey] = timer;
        timer.Start();
    }

    private async Task SaveLabelAsync(string customer, string projectId, string label)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(label))
            {
                // Empty label = delete
                await ProjectLabelService.DeleteProjectLabelAsync(customer, projectId);
            }
            else
            {
                await ProjectLabelService.SetProjectLabelAsync(customer, projectId, label.Trim());
            }

            // Reload projects to get updated display strings
            await LoadProjectsAsync();

            // Show success notification
            SavedProjectId = projectId;
            ShowSaveNotification = true;
            ShowErrorNotification = false;
            notificationKey++;
            await InvokeAsync(StateHasChanged);

            // Hide notification after 3 seconds
            await Task.Delay(3000);
            ShowSaveNotification = false;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            // Show error notification
            NotificationError = ex.Message;
            ShowErrorNotification = true;
            ShowSaveNotification = false;
            notificationKey++;
            await InvokeAsync(StateHasChanged);

            // Hide notification after 5 seconds
            await Task.Delay(5000);
            ShowErrorNotification = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private string GetTimeAgo(DateTime timestamp)
    {
        var elapsed = DateTime.Now - timestamp;

        if (elapsed.TotalSeconds < 60)
            return "just now";
        if (elapsed.TotalMinutes < 60)
            return $"{(int)elapsed.TotalMinutes} minute{((int)elapsed.TotalMinutes == 1 ? "" : "s")} ago";
        if (elapsed.TotalHours < 24)
            return $"{(int)elapsed.TotalHours} hour{((int)elapsed.TotalHours == 1 ? "" : "s")} ago";

        return $"{(int)elapsed.TotalDays} day{((int)elapsed.TotalDays == 1 ? "" : "s")} ago";
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    // Edit mode helper methods
    private string GetEditKey(string customer, string projectId) => $"{customer}:{projectId}";

    private bool IsEditing(string editKey) => _editingProjects.ContainsKey(editKey);

    private string GetEditingValue(string editKey) => _editingProjects.GetValueOrDefault(editKey, string.Empty);

    private void OnEditingValueChanged(string editKey, string value)
    {
        _editingProjects[editKey] = value;
    }

    private async Task EnterEditMode(string customer, string projectId, string? currentLabel)
    {
        var editKey = GetEditKey(customer, projectId);
        _editingProjects[editKey] = currentLabel ?? string.Empty;
        StateHasChanged();

        // Focus the input field after render
        await Task.Delay(10);
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", "document.querySelector('.inline-edit-input')?.focus()");
        }
        catch
        {
            // Ignore focus errors
        }
    }

    private void ExitEditMode(string customer, string projectId)
    {
        var editKey = GetEditKey(customer, projectId);

        if (_editingProjects.TryGetValue(editKey, out var editedValue))
        {
            _editingProjects.Remove(editKey);

            // Trigger save with the edited value
            OnLabelChanged(customer, projectId, editedValue);
        }

        StateHasChanged();
    }

    private void OnEditKeyDown(KeyboardEventArgs e, string customer, string projectId)
    {
        if (e.Key == "Enter")
        {
            ExitEditMode(customer, projectId);
        }
        else if (e.Key == "Escape")
        {
            // Cancel editing without saving
            var editKey = GetEditKey(customer, projectId);
            _editingProjects.Remove(editKey);
            StateHasChanged();
        }
    }

    // Status editing methods
    private string GetStatusKey(string customer, string projectId) => $"{customer}:{projectId}:status";

    private bool IsEditingStatus(string statusKey) => _editingStatusTenant != null && _editingStatusProjectId != null && GetStatusKey(_editingStatusTenant, _editingStatusProjectId) == statusKey;

    private ProjectLifecycleStatus GetProjectStatus(string customer, string projectId)
    {
        if (_projectMetadata.TryGetValue(customer, out var tenantProjects))
        {
            if (tenantProjects.TryGetValue(projectId, out var metadata))
            {
                return metadata.Status;
            }
        }
        return ProjectLifecycleStatus.Open; // Default
    }

    private void StartEditingStatus(string customer, string projectId)
    {
        _editingStatusTenant = customer;
        _editingStatusProjectId = projectId;
        StateHasChanged();
    }

    private async Task SaveStatus(string customer, string projectId, string? statusValue)
    {
        Console.WriteLine($"[Home.razor] SaveStatus called: customer={customer}, projectId={projectId}, statusValue={statusValue}");

        if (Enum.TryParse<ProjectLifecycleStatus>(statusValue, out var newStatus))
        {
            Console.WriteLine($"[Home.razor] Parsed status: {newStatus}");
            await MetadataService.UpdateProjectStatus(customer, projectId, newStatus);
            Console.WriteLine($"[Home.razor] UpdateProjectStatus completed");

            _projectMetadata = await MetadataService.GetAllProjects();
            Console.WriteLine($"[Home.razor] Reloaded metadata, projects count: {_projectMetadata.Count}");

            // Log the updated status
            if (_projectMetadata.TryGetValue(customer, out var tenantProjects))
            {
                if (tenantProjects.TryGetValue(projectId, out var metadata))
                {
                    Console.WriteLine($"[Home.razor] Verified new status in metadata: {metadata.Status}");
                }
            }
        }
        else
        {
            Console.WriteLine($"[Home.razor] Failed to parse status value: {statusValue}");
        }

        _editingStatusTenant = null;
        _editingStatusProjectId = null;

        Console.WriteLine($"[Home.razor] Calling StateHasChanged");
        StateHasChanged();
    }

    private void CancelEditingStatus()
    {
        _editingStatusTenant = null;
        _editingStatusProjectId = null;
        StateHasChanged();
    }

    private void HandleStatusKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            CancelEditingStatus();
        }
    }

    private string GetStatusDisplayText(ProjectLifecycleStatus status)
    {
        return status switch
        {
            ProjectLifecycleStatus.InProgress => "In Progress",
            _ => status.ToString()
        };
    }

    // Project deletion state
    private bool showDeleteConfirmation = false;
    private string deleteConfirmationMessage = string.Empty;
    private string? pendingDeleteCustomer = null;
    private string? pendingDeleteProjectId = null;
    private string? pendingDeleteDisplayString = null;
    private ToastNotification? toastNotification;

    private void ShowDeleteConfirmation(string customer, string projectId, string displayString)
    {
        pendingDeleteCustomer = customer;
        pendingDeleteProjectId = projectId;
        pendingDeleteDisplayString = displayString;
        deleteConfirmationMessage = $"Are you sure you want to delete '{displayString}'? This action cannot be undone.";
        showDeleteConfirmation = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirmation = false;
        pendingDeleteCustomer = null;
        pendingDeleteProjectId = null;
        pendingDeleteDisplayString = null;
    }

    private async Task ConfirmDelete()
    {
        showDeleteConfirmation = false;

        if (string.IsNullOrEmpty(pendingDeleteCustomer) || string.IsNullOrEmpty(pendingDeleteProjectId))
        {
            return;
        }

        try
        {
            // Store info before deletion for auto-selection logic
            var deletedCustomer = pendingDeleteCustomer;
            var deletedProjectId = pendingDeleteProjectId;
            var deletedDisplayString = pendingDeleteDisplayString ?? deletedProjectId;

            Logger.LogInformation("Deleting project {Customer}/{ProjectId}", deletedCustomer, deletedProjectId);

            // Call the service directly
            var result = await ProjectDeletionService.DeleteProjectAsync(deletedCustomer, deletedProjectId);

            if (result?.Success == true)
            {
                if (result.HasWarnings)
                {
                    // Partial success
                    var warnings = result.Details?.GetWarningsSummary() ?? "Some operations failed";
                    ToastNotification.ShowWarning($"Project deleted with warnings: {warnings}");
                }
                else
                {
                    // Full success
                    ToastNotification.ShowSuccess($"Project '{deletedDisplayString}' deleted successfully");
                }

                // Auto-select next project
                await AutoSelectNextProjectAsync(deletedCustomer, deletedProjectId);

                // Reload project list
                await LoadProjectsAsync();

                // Update project count
                ProjectCount = ProjectsByCustomer.Values.Sum(list => list.Count);
            }
            else
            {
                var errorMessage = result?.Message ?? "Unknown error occurred";
                ToastNotification.ShowError($"Failed to delete project: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting project {Customer}/{ProjectId}", pendingDeleteCustomer, pendingDeleteProjectId);
            ToastNotification.ShowError($"Error deleting project: {ex.Message}");
        }
        finally
        {
            pendingDeleteCustomer = null;
            pendingDeleteProjectId = null;
            pendingDeleteDisplayString = null;
        }
    }

    private async Task AutoSelectNextProjectAsync(string deletedCustomer, string deletedProjectId)
    {
        try
        {
            // Get all projects for the customer
            if (ProjectsByCustomer.TryGetValue(deletedCustomer, out var projects))
            {
                var projectList = projects.OrderBy(p => p.ProjectId).ToList();
                var deletedIndex = projectList.FindIndex(p => p.ProjectId == deletedProjectId);

                if (deletedIndex >= 0)
                {
                    // Select next project in the list, or previous if deleted was last
                    ProjectInfo? nextProject = null;

                    if (deletedIndex < projectList.Count - 1)
                    {
                        // Select next project
                        nextProject = projectList[deletedIndex + 1];
                    }
                    else if (deletedIndex > 0)
                    {
                        // Select previous project (deleted was last)
                        nextProject = projectList[deletedIndex - 1];
                    }

                    if (nextProject != null)
                    {
                        Logger.LogInformation("Auto-selecting next project: {Customer}/{ProjectId}",
                            nextProject.Customer, nextProject.ProjectId);

                        // Update user selections (this will be used by other pages like Transform)
                        // You may need to call IUserSelectionService here if you want to persist the selection
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to auto-select next project after deletion");
        }
    }

    // Sort-related methods
    private async Task LoadSortOrderFromStorage()
    {
        try
        {
            var storedValue = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", SortOrderStorageKey);
            if (!string.IsNullOrEmpty(storedValue) && Enum.TryParse<SortOrder>(storedValue, out var sortOrder))
            {
                SelectedSortOrder = sortOrder;
                Console.WriteLine($"[Home.razor] Loaded sort order from storage: {SelectedSortOrder}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Home.razor] Failed to load sort order from storage: {ex.Message}");
        }
    }

    private async Task OnSortOrderChanged()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", SortOrderStorageKey, SelectedSortOrder.ToString());
            Console.WriteLine($"[Home.razor] Saved sort order to storage: {SelectedSortOrder}");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Home.razor] Failed to save sort order to storage: {ex.Message}");
        }
    }

    private IEnumerable<ProjectInfo> SortProjects(List<ProjectInfo> projects)
    {
        return SelectedSortOrder switch
        {
            SortOrder.LastModifiedDesc => projects.OrderByDescending(p => GetProjectLastModified(p.Customer, p.ProjectId)),
            SortOrder.LastModifiedAsc => projects.OrderBy(p => GetProjectLastModified(p.Customer, p.ProjectId)),
            SortOrder.NameAsc => projects.OrderBy(p => p.DisplayString),
            SortOrder.NameDesc => projects.OrderByDescending(p => p.DisplayString),
            SortOrder.ProjectStatusDesc => projects
                .OrderBy(p => GetProjectStatusPriority(p.Customer, p.ProjectId))
                .ThenByDescending(p => GetProjectLastModified(p.Customer, p.ProjectId)),
            SortOrder.ProjectIdAsc => projects.OrderBy(p => p.ProjectId, StringComparer.OrdinalIgnoreCase),
            SortOrder.ProjectIdDesc => projects.OrderByDescending(p => p.ProjectId, StringComparer.OrdinalIgnoreCase),
            _ => projects.OrderByDescending(p => GetProjectLastModified(p.Customer, p.ProjectId))
        };
    }

    private int GetProjectStatusPriority(string customer, string projectId)
    {
        // Lower number = higher priority (sorts first)
        // Priority: Ready -> InProgress -> Open -> Parked
        var status = GetProjectStatus(customer, projectId);
        return status switch
        {
            ProjectLifecycleStatus.Ready => 0,
            ProjectLifecycleStatus.InProgress => 1,
            ProjectLifecycleStatus.Open => 2,
            ProjectLifecycleStatus.Parked => 3,
            _ => 4
        };
    }

    private DateTime GetProjectLastModified(string customer, string projectId)
    {
        try
        {
            var projectPath = Path.Combine("data/input", customer, "projects", projectId);
            if (Directory.Exists(projectPath))
            {
                var dirInfo = new DirectoryInfo(projectPath);
                return dirInfo.LastWriteTime;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Home.razor] Failed to get LastModified for {customer}/{projectId}: {ex.Message}");
        }
        return DateTime.MinValue;
    }

    // Pattern re-indexing
    private bool IsReindexing { get; set; }
    private List<string> ReindexingLogs { get; set; } = new();
    private ElementReference logContainerRef;
    private CancellationTokenSource? _reindexingCts;

    private async Task StartReindexing()
    {
        if (IsReindexing) return;

        try
        {
            IsReindexing = true;
            ReindexingLogs.Clear();
            _reindexingCts = new CancellationTokenSource();

            var progress = new Progress<string>(message =>
            {
                ReindexingLogs.Add(message);
                InvokeAsync(async () =>
                {
                    StateHasChanged();
                    await ScrollToBottomAsync();
                });
            });

            var result = await PatternReindexingService.ReindexPatternsAsync(progress, _reindexingCts.Token);

            if (!result.Success && !string.IsNullOrEmpty(result.ErrorMessage))
            {
                Logger.LogError("Pattern re-indexing failed: {Error}", result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during pattern re-indexing");
            ReindexingLogs.Add($"[{DateTime.Now:HH:mm:ss}] ERROR: {ex.Message}");
        }
        finally
        {
            IsReindexing = false;
            _reindexingCts?.Dispose();
            _reindexingCts = null;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ClearReindexingLogs()
    {
        ReindexingLogs.Clear();
        StateHasChanged();
    }

    private string GetLogClass(string log)
    {
        if (log.Contains("ERROR:"))
            return "log-error";
        if (log.Contains("WARNING:"))
            return "log-warning";
        if (log.Contains("‚úì") || log.Contains("complete"))
            return "log-success";
        return "log-info";
    }

    private async Task ScrollToBottomAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval",
                "setTimeout(() => { const el = document.querySelector('.log-content'); if (el) el.scrollTop = el.scrollHeight; }, 50)");
        }
        catch
        {
            // Ignore JS interop errors
        }
    }

    // Add Project Modal state
    private bool showAddProjectModal = false;

    private void ShowAddProjectModal()
    {
        showAddProjectModal = true;
    }

    private void CloseAddProjectModal()
    {
        showAddProjectModal = false;
    }

    private async Task OnProjectCreated()
    {
        showAddProjectModal = false;

        // Reload projects to show the new project
        await LoadProjectsAsync();

        // Update project count
        ProjectCount = ProjectsByCustomer.Values.Sum(list => list.Count);

        // Show success toast
        ToastNotification.ShowSuccess("Project created successfully");
    }

    // Project Files Modal state
    private bool showProjectFilesModal = false;
    private string selectedProjectCustomer = string.Empty;
    private string selectedProjectId = string.Empty;
    private string selectedProjectDisplayString = string.Empty;

    private void ShowProjectFilesModal(string customer, string projectId, string displayString)
    {
        selectedProjectCustomer = customer;
        selectedProjectId = projectId;
        selectedProjectDisplayString = displayString;
        showProjectFilesModal = true;
    }

    private void CloseProjectFilesModal()
    {
        showProjectFilesModal = false;
        selectedProjectCustomer = string.Empty;
        selectedProjectId = string.Empty;
        selectedProjectDisplayString = string.Empty;
    }

    private async Task OnFilesUploaded()
    {
        // Optionally reload projects or show notification
        Logger.LogInformation("Files uploaded for {Customer}/{ProjectId}", selectedProjectCustomer, selectedProjectId);

        // Reload projects to update last modified time
        await LoadProjectsAsync();
    }

    public void Dispose()
    {
        // Unsubscribe from events
        ProjectDirectoryWatcherService.ProjectsChanged -= OnProjectsChangedAsync;

        // Stop directory watcher
        ProjectDirectoryWatcherService.StopWatching();

        // Clean up all debounce timers
        foreach (var timer in _debounceTimers.Values)
        {
            timer.Stop();
            timer.Dispose();
        }
        _debounceTimers.Clear();

        // Cancel re-indexing if in progress
        _reindexingCts?.Cancel();
        _reindexingCts?.Dispose();
    }
}
