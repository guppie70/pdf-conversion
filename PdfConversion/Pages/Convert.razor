@page "/convert"
@using System
@using System.IO
@using System.Xml.Linq
@using PdfConversion.Services
@using PdfConversion.Models
@using PdfConversion.Components
@inject IProjectManagementService ProjectService
@inject IConversionService ConversionService
@inject IRoundTripValidationService ValidationService
@inject IUserSelectionService UserSelectionService
@inject ILogger<Pages.Convert> Logger
@inject IJSRuntime JSRuntime
@inject ProjectMetadataService MetadataService
@implements IDisposable

<PageTitle>Convert: PDF to Taxxor Sections</PageTitle>

<div class="convert-container">
    <div class="convert-header">
        <h3>Convert: PDF to Taxxor Sections</h3>
        <p class="text-muted">Convert transformed PDF documents into individual Taxxor section XML files</p>
    </div>

    <!-- Configuration Panel -->
    <div class="convert-panel">
        <div class="panel-header">
            <h5>Configuration</h5>
        </div>
        <div class="panel-body">
            <div class="row g-3">
                <!-- Project Selection -->
                <div class="col-md-4">
                    <label for="projectSelect" class="form-label">Project</label>
                    <select id="projectSelect"
                            class="form-select"
                            @onchange="OnProjectChanged"
                            value="@_config.ProjectId"
                            disabled="@IsProcessing">
                        <option value="">-- Select Project --</option>
                        @if (Projects != null)
                        {
                            @foreach (var project in Projects)
                            {
                                <option value="@project.ProjectId">@project.Name</option>
                            }
                        }
                    </select>
                </div>

                <!-- Source File Selection -->
                <div class="col-md-4">
                    <label for="sourceFileSelect" class="form-label">Source File</label>
                    <select id="sourceFileSelect"
                            class="form-select"
                            @onchange="OnSourceFileChanged"
                            value="@_config.SourceFile"
                            disabled="@(!IsProjectSelected || IsProcessing)">
                        <option value="">-- Select Source File --</option>
                        @if (SourceFiles != null)
                        {
                            @foreach (var file in SourceFiles)
                            {
                                <option value="@file">@file</option>
                            }
                        }
                    </select>
                </div>

                <!-- Hierarchy File Selection -->
                <div class="col-md-4">
                    <label for="hierarchyFileSelect" class="form-label">Hierarchy File</label>
                    <select id="hierarchyFileSelect"
                            class="form-select"
                            @onchange="OnHierarchyFileChanged"
                            value="@_config.HierarchyFile"
                            disabled="@(!IsProjectSelected || IsProcessing)">
                        <option value="">-- Select Hierarchy File --</option>
                        @if (HierarchyFiles != null)
                        {
                            @foreach (var file in HierarchyFiles)
                            {
                                <option value="@file">@file</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-primary"
                            @onclick="StartConversion"
                            disabled="@(!_config.IsValid || IsProcessing)">
                        <i class="bi bi-play-circle"></i> Start Conversion
                    </button>
                    <button class="btn btn-danger ms-2"
                            @onclick="StopConversion"
                            disabled="@(!IsProcessing)">
                        <i class="bi bi-stop-circle"></i> Stop
                    </button>
                </div>
            </div>

            <!-- Validation Feedback -->
            @if (!_config.IsValid && !IsProcessing)
            {
                <div class="alert alert-info mt-3" role="alert">
                    <i class="bi bi-info-circle"></i>
                    <strong>Required Fields:</strong>
                    <ul class="mb-0 mt-1">
                        @if (string.IsNullOrEmpty(_config.ProjectId))
                        {
                            <li>Please select a <strong>Project</strong></li>
                        }
                        @if (string.IsNullOrEmpty(_config.SourceFile))
                        {
                            <li>Please select a <strong>Source File</strong></li>
                        }
                        @if (string.IsNullOrEmpty(_config.HierarchyFile))
                        {
                            <li>Please select a <strong>Hierarchy File</strong></li>
                        }
                    </ul>
                </div>
            }
        </div>
    </div>

    <!-- Progress Panel -->
    @if (IsProcessing || ProcessingComplete)
    {
        <div class="convert-panel mt-3">
            <div class="panel-header">
                <h5>Progress</h5>
            </div>
            <div class="panel-body">
                <div class="progress-info">
                    <span>Processing: @CurrentItemIndex / @TotalItems sections (@ProgressPercentage%)</span>
                </div>
                <div class="progress mt-2" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped @(IsProcessing ? "progress-bar-animated" : "") @(CurrentItemName == "Cancelled" ? "bg-warning" : "")"
                         role="progressbar"
                         style="width: @ProgressPercentage%"
                         aria-valuenow="@ProgressPercentage"
                         aria-valuemin="0"
                         aria-valuemax="100">
                        @ProgressPercentage%
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(CurrentItemName))
                {
                    <div class="mt-2 @(CurrentItemName == "Cancelled" ? "text-warning" : "text-muted")">
                        <strong>Status:</strong>
                        @if (CurrentItemName == "Cancelled")
                        {
                            <span>@CurrentItemName (conversion stopped at section @CurrentItemIndex of @TotalItems)</span>
                        }
                        else if (CurrentItemName == "Complete")
                        {
                            <span>@CurrentItemName</span>
                        }
                        else if (CurrentItemName == "Failed")
                        {
                            <span class="text-danger">@CurrentItemName</span>
                        }
                        else
                        {
                            <span>Processing "@CurrentItemName"...</span>
                        }
                    </div>
                }
            </div>
        </div>
    }

    <!-- Validation Panel -->
    @if (ProcessingComplete && !string.IsNullOrEmpty(_config.ProjectId) && CurrentItemName != "Cancelled")
    {
        <div class="convert-panel mt-3">
            <div class="panel-header">
                <h5>Round-Trip Validation</h5>
                <button class="btn btn-sm btn-primary"
                        @onclick="StartValidation"
                        disabled="@IsValidating">
                    @if (IsValidating)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>Validating...</span>
                    }
                    else
                    {
                        <i class="bi bi-check-circle"></i>
                        <span> Validate Round-Trip</span>
                    }
                </button>
            </div>
            <div class="panel-body">
                @if (ValidationResult == null && !IsValidating)
                {
                    <div class="text-center text-muted p-4">
                        <i class="bi bi-info-circle fs-3"></i>
                        <p class="mt-2 mb-0">
                            Click "Validate Round-Trip" to verify that sections can be reconstructed back to the original normalized XML.
                        </p>
                    </div>
                }
                else
                {
                    <DiffViewer ValidationResult="@ValidationResult" />
                }
            </div>
        </div>
    }

    <!-- Log Panel -->
    <div class="convert-panel mt-3">
        <div class="panel-header">
            <h5>Log</h5>
            <button class="btn btn-sm btn-outline-secondary" @onclick="ClearLog">
                <i class="bi bi-trash"></i> Clear
            </button>
        </div>
        <div class="panel-body">
            <div class="log-viewer" @ref="_logViewerElement">
                @if (LogEntries.Any())
                {
                    @foreach (var entry in LogEntries)
                    {
                        <div class="log-entry">
                            <span class="log-time">[@entry.Time.ToString("HH:mm:ss")]</span>
                            <span class="log-message">@entry.Message</span>
                        </div>
                    }
                }
                else
                {
                    <div class="text-muted text-center p-4">
                        No log entries yet. Select configuration and start conversion.
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Duplicate Match Modal -->
    <DuplicateMatchModal DuplicateMatches="_pendingDuplicates"
                         TransformedDocument="_transformedDocumentContext"
                         ProcessedMatches="_processedMatchesContext"
                         AllHierarchyItems="_allHierarchyItems"
                         CurrentHierarchyItem="_currentHierarchyItem"
                         IsVisible="_showDuplicateModal"
                         CancellationTokenSource="_cancellationTokenSource"
                         OnSelectionConfirmed="HandleDuplicateSelectionConfirmed" />
</div>

@code {
    // Configuration
    private readonly ConversionConfiguration _config = new();

    // State
    private List<Project>? Projects;
    private List<string>? SourceFiles;
    private List<string>? HierarchyFiles;
    private bool IsProcessing = false;
    private bool ProcessingComplete = false;

    // Progress tracking
    private int CurrentItemIndex = 0;
    private int TotalItems = 0;
    private string? CurrentItemName;
    private int ProgressPercentage => TotalItems > 0 ? (CurrentItemIndex * 100 / TotalItems) : 0;

    // Cancellation support
    private CancellationTokenSource? _cancellationTokenSource;

    // Duplicate selection support
    private List<HeaderMatch>? _pendingDuplicates;
    private TaskCompletionSource<HeaderMatch?>? _duplicateSelectionTcs;
    private bool _showDuplicateModal = false;
    private XDocument? _transformedDocumentContext;
    private List<HeaderMatch>? _processedMatchesContext;
    private List<HierarchyItem>? _allHierarchyItems;
    private HierarchyItem? _currentHierarchyItem;

    // Log
    private readonly List<LogEntry> LogEntries = new();
    private ElementReference _logViewerElement;

    // Validation
    private bool IsValidating = false;
    private RoundTripValidationResult? ValidationResult = null;

    // Computed properties
    private bool IsProjectSelected => !string.IsNullOrEmpty(_config.ProjectId);

    protected override async Task OnInitializedAsync()
    {
        await LoadProjectsAsync();
        await RestoreSavedSelectionsAsync();
    }

    private async Task RestoreSavedSelectionsAsync()
    {
        try
        {
            string? savedProjectId = null;
            string? savedSourceFile = null;
            string? savedHierarchyFile = null;

            // First, try to restore from UserSelectionService (server-side JSON)
            try
            {
                var selection = await UserSelectionService.GetSelectionAsync();

                if (!string.IsNullOrEmpty(selection.LastSelectedProject))
                {
                    // Convert short project ID (e.g., "ar24-3") to full path format (e.g., "optiver/ar24-3")
                    // by looking up the matching project in the Projects list
                    var matchingProject = Projects?.FirstOrDefault(p =>
                        p.ProjectId.EndsWith("/" + selection.LastSelectedProject, StringComparison.OrdinalIgnoreCase) ||
                        p.ProjectId.Equals(selection.LastSelectedProject, StringComparison.OrdinalIgnoreCase));

                    if (matchingProject != null)
                    {
                        savedProjectId = matchingProject.ProjectId;
                        savedSourceFile = selection.LastSelectedSourceXml;
                        savedHierarchyFile = selection.LastSelectedHierarchyXml;
                        Logger.LogInformation("Restored selections from UserSelectionService: Project={Project}, Source={Source}, Hierarchy={Hierarchy}",
                            savedProjectId, savedSourceFile, savedHierarchyFile);
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Error restoring selections from UserSelectionService, falling back to localStorage");
            }

            // Fallback to localStorage if UserSelectionService didn't provide values
            if (string.IsNullOrEmpty(savedProjectId))
            {
                savedProjectId = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "convert.projectId");
                savedSourceFile = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "convert.sourceFile");
                savedHierarchyFile = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "convert.hierarchyFile");

                if (!string.IsNullOrEmpty(savedProjectId))
                {
                    Logger.LogInformation("Restored selections from localStorage: Project={Project}, Source={Source}, Hierarchy={Hierarchy}",
                        savedProjectId, savedSourceFile, savedHierarchyFile);
                }
            }

            // Apply the restored selections
            if (!string.IsNullOrEmpty(savedProjectId) && Projects?.Any(p => p.ProjectId == savedProjectId) == true)
            {
                _config.ProjectId = savedProjectId;
                await LoadProjectFilesAsync(savedProjectId);

                // Restore source file selection
                if (!string.IsNullOrEmpty(savedSourceFile) && SourceFiles?.Contains(savedSourceFile) == true)
                {
                    _config.SourceFile = savedSourceFile;
                }

                // Restore hierarchy file selection
                if (!string.IsNullOrEmpty(savedHierarchyFile) && HierarchyFiles?.Contains(savedHierarchyFile) == true)
                {
                    _config.HierarchyFile = savedHierarchyFile;
                }

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Error restoring saved selections");
        }
    }

    private async Task LoadProjectFilesAsync(string projectId)
    {
        // Load source files (XML files in project root)
        var allFiles = (await ProjectService.GetProjectFilesAsync(projectId)).ToList();
        SourceFiles = allFiles.Where(f => f.EndsWith(".xml", StringComparison.OrdinalIgnoreCase)).ToList();

        // Load hierarchy files (XML files in metadata subfolder)
        var metadataPath = Path.Combine("/app/data/input/optiver/projects", projectId, "metadata");
        if (Directory.Exists(metadataPath))
        {
            HierarchyFiles = Directory.GetFiles(metadataPath, "*.xml")
                .Select(Path.GetFileName)
                .Where(f => !string.IsNullOrEmpty(f))
                .Cast<string>()
                .ToList();
        }
        else
        {
            HierarchyFiles = new List<string>();
        }

        Logger.LogInformation("Loaded {SourceCount} source files and {HierarchyCount} hierarchy files for project {ProjectId}",
            SourceFiles.Count, HierarchyFiles.Count, projectId);
    }

    private async Task LoadProjectsAsync()
    {
        try
        {
            // Get all projects from ProjectService
            var allProjects = (await ProjectService.GetProjectsAsync()).ToList();

            // Get active projects from MetadataService
            var activeProjectMetadata = await MetadataService.GetActiveProjects();

            // Filter to only include active projects (must have metadata entry)
            Projects = allProjects.Where(p =>
            {
                if (activeProjectMetadata.TryGetValue(p.Organization, out var tenantProjects))
                {
                    return tenantProjects.ContainsKey(p.ProjectId);
                }
                // If no metadata exists for this tenant/project, exclude it
                return false;
            }).ToList();

            // Merge custom labels from metadata
            foreach (var project in Projects)
            {
                if (activeProjectMetadata.TryGetValue(project.Organization, out var tenantProjects) &&
                    tenantProjects.TryGetValue(project.ProjectId, out var metadata) &&
                    !string.IsNullOrWhiteSpace(metadata.Label))
                {
                    project.Name = $"{metadata.Label} ({project.ProjectId})";
                }
            }

            Logger.LogInformation("Loaded {Count} active projects", Projects.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading projects");
            AddLogEntry($"Error loading projects: {ex.Message}");
        }
    }

    private async Task OnProjectChanged(ChangeEventArgs e)
    {
        try
        {
            _config.ProjectId = e.Value?.ToString();
            _config.SourceFile = null;
            _config.HierarchyFile = null;
            SourceFiles = null;
            HierarchyFiles = null;

            if (!string.IsNullOrEmpty(_config.ProjectId))
            {
                await LoadProjectFilesAsync(_config.ProjectId);

                // Save to localStorage (existing)
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "convert.projectId", _config.ProjectId);
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "convert.sourceFile");
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "convert.hierarchyFile");

                // Save to UserSelectionService (new)
                // Extract just the project ID from full path (e.g., "optiver/ar24-3" → "ar24-3")
                var projectId = _config.ProjectId.Contains('/')
                    ? _config.ProjectId.Split('/').Last()
                    : _config.ProjectId;
                await UserSelectionService.UpdateSelectionAsync(projectId: projectId, sourceXml: string.Empty, hierarchyXml: string.Empty);

                AddLogEntry($"Project selected: {_config.ProjectId}");
            }
            else
            {
                // Clear localStorage (existing)
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "convert.projectId");
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "convert.sourceFile");
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "convert.hierarchyFile");

                // Clear UserSelectionService (new)
                await UserSelectionService.UpdateSelectionAsync(projectId: string.Empty, sourceXml: string.Empty, hierarchyXml: string.Empty);
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading project files");
            AddLogEntry($"Error loading project files: {ex.Message}");
        }
    }

    private async Task OnSourceFileChanged(ChangeEventArgs e)
    {
        _config.SourceFile = e.Value?.ToString();
        if (!string.IsNullOrEmpty(_config.SourceFile))
        {
            // Save to localStorage (existing)
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "convert.sourceFile", _config.SourceFile);

            // Save to UserSelectionService (new)
            await UserSelectionService.UpdateSelectionAsync(sourceXml: _config.SourceFile);

            AddLogEntry($"Source file selected: {_config.SourceFile}");
        }
        else
        {
            // Clear localStorage (existing)
            await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "convert.sourceFile");

            // Clear UserSelectionService (new)
            await UserSelectionService.UpdateSelectionAsync(sourceXml: string.Empty);
        }
        StateHasChanged();
    }

    private async Task OnHierarchyFileChanged(ChangeEventArgs e)
    {
        _config.HierarchyFile = e.Value?.ToString();
        if (!string.IsNullOrEmpty(_config.HierarchyFile))
        {
            // Save to localStorage (existing)
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "convert.hierarchyFile", _config.HierarchyFile);

            // Save to UserSelectionService (new)
            await UserSelectionService.UpdateSelectionAsync(hierarchyXml: _config.HierarchyFile);

            AddLogEntry($"Hierarchy file selected: {_config.HierarchyFile}");
        }
        else
        {
            // Clear localStorage (existing)
            await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "convert.hierarchyFile");

            // Clear UserSelectionService (new)
            await UserSelectionService.UpdateSelectionAsync(hierarchyXml: string.Empty);
        }
        StateHasChanged();
    }

    private async Task StartConversion()
    {
        if (!_config.IsValid) return;

        // Create new cancellation token source
        _cancellationTokenSource?.Dispose();
        _cancellationTokenSource = new CancellationTokenSource();

        IsProcessing = true;
        ProcessingComplete = false;
        CurrentItemIndex = 0;
        TotalItems = 0;
        CurrentItemName = "Initializing...";

        AddLogEntry("Starting conversion...");
        AddLogEntry($"Project: {_config.ProjectId}");
        AddLogEntry($"Source: {_config.SourceFile}");
        AddLogEntry($"Hierarchy: {_config.HierarchyFile}");
        AddLogEntry("");

        StateHasChanged();

        try
        {
            var result = await ConversionService.StartConversionAsync(
                _config.ProjectId!,
                _config.SourceFile!,
                _config.HierarchyFile!,
                AddLogEntry,
                HandleDuplicateSelection,
                _cancellationTokenSource.Token);

            TotalItems = result.TotalSections;
            CurrentItemIndex = result.SuccessfulSections + result.FailedSections;

            if (result.WasCancelled)
            {
                CurrentItemName = "Cancelled";
            }
            else
            {
                // When complete successfully, show 100% progress
                CurrentItemIndex = TotalItems;
                CurrentItemName = "Complete";
            }

            IsProcessing = false;
            ProcessingComplete = true;
            StateHasChanged();
        }
        catch (OperationCanceledException)
        {
            // Expected when cancellation is requested
            AddLogEntry("✗ Conversion cancelled by user");
            CurrentItemName = "Cancelled";
            IsProcessing = false;
            ProcessingComplete = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during conversion");
            AddLogEntry($"✗ Error: {ex.Message}");
            CurrentItemName = "Failed";
            IsProcessing = false;
            ProcessingComplete = false;
            StateHasChanged();
        }
        finally
        {
            // Clean up cancellation token source
            _cancellationTokenSource?.Dispose();
            _cancellationTokenSource = null;
        }
    }

    private Task StopConversion()
    {
        if (_cancellationTokenSource != null && !_cancellationTokenSource.IsCancellationRequested)
        {
            AddLogEntry("Stopping conversion...");
            _cancellationTokenSource.Cancel();
        }

        return Task.CompletedTask;
    }

    public void Dispose()
    {
        _cancellationTokenSource?.Dispose();
    }

    private void AddLogEntry(string message)
    {
        LogEntries.Add(new LogEntry
        {
            Time = DateTime.Now,
            Message = message
        });

        // Auto-scroll to bottom (will be implemented with JS interop if needed)
        StateHasChanged();
    }

    private void ClearLog()
    {
        LogEntries.Clear();
        StateHasChanged();
    }

    private async Task<HeaderMatch?> HandleDuplicateSelection(
        List<HeaderMatch> duplicates,
        XDocument transformedDocument,
        List<HeaderMatch> processedMatches,
        List<HierarchyItem> allHierarchyItems,
        HierarchyItem currentHierarchyItem)
    {
        // Create a new TaskCompletionSource to wait for user selection
        _duplicateSelectionTcs = new TaskCompletionSource<HeaderMatch?>();
        _pendingDuplicates = duplicates;
        _transformedDocumentContext = transformedDocument;
        _processedMatchesContext = processedMatches;
        _allHierarchyItems = allHierarchyItems;
        _currentHierarchyItem = currentHierarchyItem;
        _showDuplicateModal = true;

        // Trigger UI update to show modal
        StateHasChanged();

        // Wait for user to make selection
        var selectedMatch = await _duplicateSelectionTcs.Task;

        // Clean up
        _duplicateSelectionTcs = null;
        _pendingDuplicates = null;
        _transformedDocumentContext = null;
        _processedMatchesContext = null;
        _allHierarchyItems = null;
        _currentHierarchyItem = null;

        return selectedMatch;
    }

    private async Task HandleDuplicateSelectionConfirmed(HeaderMatch? selectedMatch)
    {
        // Hide modal
        _showDuplicateModal = false;
        StateHasChanged();

        // Complete the TaskCompletionSource with the user's selection
        if (_duplicateSelectionTcs != null && !_duplicateSelectionTcs.Task.IsCompleted)
        {
            _duplicateSelectionTcs.SetResult(selectedMatch);
        }

        await Task.CompletedTask;
    }

    private async Task StartValidation()
    {
        if (string.IsNullOrEmpty(_config.ProjectId))
        {
            Logger.LogWarning("Cannot start validation: no project selected");
            return;
        }

        IsValidating = true;
        ValidationResult = null;
        StateHasChanged();

        try
        {
            Logger.LogInformation("Starting round-trip validation for project {ProjectId}", _config.ProjectId);

            ValidationResult = await ValidationService.ValidateRoundTripAsync(_config.ProjectId);

            Logger.LogInformation("Round-trip validation completed: {Result}", ValidationResult.ToString());
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during round-trip validation");
            ValidationResult = new RoundTripValidationResult
            {
                Success = false,
                ErrorMessage = $"Validation error: {ex.Message}"
            };
        }
        finally
        {
            IsValidating = false;
            StateHasChanged();
        }
    }

    private class LogEntry
    {
        public DateTime Time { get; set; }
        public string Message { get; set; } = string.Empty;
    }
}
