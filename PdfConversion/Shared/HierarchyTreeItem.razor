@using PdfConversion.Models

<div class="tree-item" style="margin-left: @(Level * 20)px" @onclick="HandleItemClick" @onclick:stopPropagation="true">
    <div class="tree-item-content">
        @if (Item.SubItems.Any())
        {
            <button class="btn btn-sm tree-toggle" @onclick="ToggleExpanded" @onclick:stopPropagation="true">
                <i class="bi @(IsExpanded ? "bi-chevron-down" : "bi-chevron-right")"></i>
            </button>
        }
        else
        {
            <span class="tree-spacer"></span>
        }

        <span class="level-badge">L@(Item.Level)</span>

        @if (IsEditing)
        {
            <input type="text"
                   class="form-control form-control-sm tree-edit-input"
                   @bind="EditedLinkName"
                   @onblur="SaveEdit"
                   @onkeydown="HandleKeyDown"
                   @onclick:stopPropagation="true" />
        }
        else
        {
            <span class="tree-item-label" @ondblclick="StartEdit" @ondblclick:stopPropagation="true">@Item.LinkName</span>
        }

        @if (Item.Confidence.HasValue)
        {
            <span class="confidence-badge confidence-@GetConfidenceClass(Item.Confidence.Value)">
                @Item.Confidence%
            </span>
        }

        @if (Item.IsUncertain)
        {
            <i class="bi bi-exclamation-triangle text-warning" title="Uncertain placement"></i>
        }
    </div>
</div>

@if (IsExpanded && Item.SubItems.Any())
{
    @foreach (var subItem in Item.SubItems)
    {
        <HierarchyTreeItem Item="subItem"
                          Level="Level + 1"
                          OnItemSelected="OnItemSelected"
                          OnItemEdited="OnItemEdited" />
    }
}

@code {
    [Parameter, EditorRequired]
    public HierarchyItem Item { get; set; } = null!;

    [Parameter]
    public int Level { get; set; }

    [Parameter]
    public EventCallback<HierarchyItem> OnItemSelected { get; set; }

    [Parameter]
    public EventCallback<HierarchyItem> OnItemEdited { get; set; }

    private bool IsExpanded { get; set; } = true;
    private bool IsEditing { get; set; }
    private string EditedLinkName { get; set; } = string.Empty;

    private async Task HandleItemClick()
    {
        await OnItemSelected.InvokeAsync(Item);
    }

    private void ToggleExpanded()
    {
        IsExpanded = !IsExpanded;
    }

    private void StartEdit()
    {
        IsEditing = true;
        EditedLinkName = Item.LinkName;
    }

    private async Task SaveEdit()
    {
        if (EditedLinkName != Item.LinkName)
        {
            Item.LinkName = EditedLinkName;
            await OnItemEdited.InvokeAsync(Item);
        }
        IsEditing = false;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SaveEdit();
        }
        else if (e.Key == "Escape")
        {
            IsEditing = false;
        }
    }

    private string GetConfidenceClass(int confidence)
    {
        return confidence >= 80 ? "high" : confidence >= 70 ? "medium" : "low";
    }
}
