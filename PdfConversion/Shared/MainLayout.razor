@inherits LayoutComponentBase
@using PdfConversion.Services
@using PdfConversion.Shared
@using PdfConversion.Utils
@using PdfConversion.Models
@inject NavigationManager Navigation
@inject TransformToolbarState ToolbarState
@inject IJSRuntime JSRuntime
@inject IProjectLabelService ProjectLabelService
@inject IUserSelectionService UserSelectionService
@inject ILogger<MainLayout> Logger
@implements IDisposable

<PageTitle>PdfConversion</PageTitle>

<div class="page">
    <header class="top-nav">
        <nav class="nav-links">
            <NavLink href="/" class="nav-link" Match="NavLinkMatch.All">Home</NavLink>

            @if (IsProjectContextActive())
            {
                var (customer, projectId) = GetCurrentProject();

                <a href="@($"/docling-convert/{customer}/{projectId}")" class="nav-link @(IsActivePage("docling-convert") ? "active" : "")">Convert</a>
                <a href="@(BuildTransformUrl(customer, projectId))" class="nav-link @(IsActivePage("transform") ? "active" : "")">Transform</a>
                <a href="@(BuildHierarchyUrl(customer, projectId))" class="nav-link @(IsActivePage("generate-hierarchy") ? "active" : "")">Generate Hierarchy</a>
                <a href="@(BuildConvertUrl(customer, projectId))" class="nav-link @(IsActivePage("convert") ? "active" : "")">Section Generation</a>
            }

            <!-- Production always visible as it operates outside project scope -->
            <div class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="developDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Develop
                </a>
                <ul class="dropdown-menu" aria-labelledby="developDropdown">
                    <li><a class="dropdown-item" href="/production">Production</a></li>
                    <li><a class="dropdown-item" href="/debug-validation">Debug Validation</a></li>
                    <li><a class="dropdown-item" href="/hierarchy-test"><i class="bi bi-robot"></i> Hierarchy Test</a></li>
                    <li><a class="dropdown-item" href="/test-modal">Test Modal</a></li>
                </ul>
            </div>
        </nav>

        @if (IsProjectContextActive())
        {
            var (customer, projectId) = GetCurrentProject();
            var displayString = GetProjectDisplayString(customer, projectId);
            <div class="project-context-indicator">
                <span class="project-path">@displayString</span>
            </div>
        }

        @if (IsOnTransformPage)
        {
            <div class="nav-toolbar">
                <div class="nav-toolbar-actions">
                    <button class="btn btn-sm btn-outline-light" @onclick="OnToggleSettings" title="Settings" data-bs-toggle="tooltip">
                        <i class="bi bi-gear-fill"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" @onclick="ToggleTransformationLog" title="View Transformation Logs" data-bs-toggle="tooltip">
                        <i class="bi bi-journal-text"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" @onclick="ToggleHelp" title="Help (?)" data-bs-toggle="tooltip">
                        <i class="bi bi-question-circle"></i>
                    </button>
                </div>
            </div>
        }
    </header>

    <main>
        <article class="content">
            @Body
        </article>
    </main>

    <ToastNotification />
    <HelpPanel IsVisible="@ShowHelp" OnClose="ToggleHelp" />
    <TransformationLogPanel IsVisible="@ShowTransformationLog" OnClose="ToggleTransformationLog" />
</div>

@code {
    private bool IsOnTransformPage => Navigation.Uri.Contains("/transform", StringComparison.OrdinalIgnoreCase);
    private bool ShowHelp = false;
    private bool ShowTransformationLog = false;
    private Dictionary<string, string> _projectCache = new();

    private bool IsProjectContextActive()
    {
        var uri = Navigation.Uri;

        // Check if current route contains /{customer}/{projectId} pattern
        // Routes: /transform/{customer}/{projectId}, /convert/{customer}/{projectId}, etc.
        var segments = new Uri(uri).AbsolutePath.Split('/', StringSplitOptions.RemoveEmptyEntries);

        // Need at least 3 segments: [page-name, customer, projectId]
        if (segments.Length < 3)
            return false;

        // Check if it's one of our workflow pages
        var workflowPages = new[] { "transform", "docling-convert", "generate-hierarchy", "convert" };
        return workflowPages.Contains(segments[0], StringComparer.OrdinalIgnoreCase);
    }

    private bool IsActivePage(string pageName)
    {
        // Match based on path only, ignoring query strings
        var segments = new Uri(Navigation.Uri).AbsolutePath.Split('/', StringSplitOptions.RemoveEmptyEntries);
        return segments.Length > 0 && segments[0].Equals(pageName, StringComparison.OrdinalIgnoreCase);
    }

    private (string Customer, string ProjectId) GetCurrentProject()
    {
        var uri = Navigation.Uri;
        var segments = new Uri(uri).AbsolutePath.Split('/', StringSplitOptions.RemoveEmptyEntries);

        if (segments.Length >= 3)
        {
            return (segments[1], segments[2]);
        }

        return (string.Empty, string.Empty);
    }

    private string GetProjectDisplayString(string customer, string projectId)
    {
        // Try to get the project from cache
        if (_projectCache.TryGetValue($"{customer}:{projectId}", out var displayString))
        {
            return displayString;
        }

        // Fallback to basic format while loading
        return $"{FilenameUtils.FormatCustomerDisplayName(customer)} / {projectId}";
    }

    private string BuildTransformUrl(string customer, string projectId)
    {
        var baseUrl = $"/transform/{customer}/{projectId}";
        var selection = GetProjectSelectionSync($"{customer}/{projectId}");

        if (selection == null)
            return baseUrl;

        var queryParams = new List<string>();

        if (!string.IsNullOrEmpty(selection.SourceFile))
            queryParams.Add($"sourceFile={Uri.EscapeDataString(selection.SourceFile)}");

        if (!string.IsNullOrEmpty(selection.XsltFile))
            queryParams.Add($"xsltFile={Uri.EscapeDataString(selection.XsltFile)}");

        if (!string.IsNullOrEmpty(selection.ViewMode))
            queryParams.Add($"view={Uri.EscapeDataString(selection.ViewMode)}");

        return queryParams.Count > 0
            ? $"{baseUrl}?{string.Join("&", queryParams)}"
            : baseUrl;
    }

    private string BuildHierarchyUrl(string customer, string projectId)
    {
        var baseUrl = $"/generate-hierarchy/{customer}/{projectId}";
        var selection = GetProjectSelectionSync($"{customer}/{projectId}");

        if (selection == null)
            return baseUrl;

        var queryParams = new List<string>();

        if (!string.IsNullOrEmpty(selection.SourceFile))
            queryParams.Add($"sourceFile={Uri.EscapeDataString(selection.SourceFile)}");

        if (!string.IsNullOrEmpty(selection.HierarchyFile))
            queryParams.Add($"hierarchyFile={Uri.EscapeDataString(selection.HierarchyFile)}");

        if (!string.IsNullOrEmpty(selection.HierarchyMode))
            queryParams.Add($"mode={Uri.EscapeDataString(selection.HierarchyMode)}");

        return queryParams.Count > 0
            ? $"{baseUrl}?{string.Join("&", queryParams)}"
            : baseUrl;
    }

    private string BuildConvertUrl(string customer, string projectId)
    {
        var baseUrl = $"/convert/{customer}/{projectId}";
        var selection = GetProjectSelectionSync($"{customer}/{projectId}");

        if (selection == null)
            return baseUrl;

        var queryParams = new List<string>();

        if (!string.IsNullOrEmpty(selection.SourceFile))
            queryParams.Add($"sourceFile={Uri.EscapeDataString(selection.SourceFile)}");

        if (!string.IsNullOrEmpty(selection.HierarchyFile))
            queryParams.Add($"hierarchyFile={Uri.EscapeDataString(selection.HierarchyFile)}");

        return queryParams.Count > 0
            ? $"{baseUrl}?{string.Join("&", queryParams)}"
            : baseUrl;
    }

    private ProjectSelection? GetProjectSelectionSync(string projectId)
    {
        // Synchronous wrapper for async call - safe because we're in render context
        // and we don't want to block UI with async NavLink href
        try
        {
            return UserSelectionService.GetProjectSelectionAsync(projectId).GetAwaiter().GetResult();
        }
        catch (Exception ex)
        {
            // Log and return null on error - fallback to bare URL
            Logger.LogError(ex, "Error retrieving project selection for {ProjectId}", projectId);
            return null;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += OnLocationChanged;
        ToolbarState.OnChange += StateHasChanged;

        // Load all projects to populate cache
        await LoadProjectCacheAsync();
    }

    private async Task LoadProjectCacheAsync()
    {
        try
        {
            var projects = await ProjectLabelService.GetAllProjectsAsync("data/input");
            _projectCache.Clear();

            foreach (var project in projects)
            {
                var key = $"{project.Customer}:{project.ProjectId}";
                // Format: "CustomerDisplay / CustomLabel or ProjectId"
                var customerDisplay = FilenameUtils.FormatCustomerDisplayName(project.Customer);
                var label = string.IsNullOrEmpty(project.CustomLabel) ? project.ProjectId : project.CustomLabel;
                _projectCache[key] = $"{customerDisplay} / {label}";
            }
        }
        catch (Exception)
        {
            // Silently fail - fallback formatting will be used
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // ThemeManager auto-initializes when shortcuts.js loads (no call needed here)

            // Initialize tooltips for dynamically rendered elements
            try
            {
                await JSRuntime.InvokeVoidAsync("TooltipManager.initialize");
            }
            catch (Exception)
            {
                // TooltipManager may not be loaded during prerendering, ignore
            }
        }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    private async Task OnTransform()
    {
        if (ToolbarState.OnTransform != null)
        {
            await ToolbarState.OnTransform();
        }
    }

    private async Task OnSave()
    {
        if (ToolbarState.OnSave != null)
        {
            await ToolbarState.OnSave();
        }
    }

    private void OnToggleSettings()
    {
        ToolbarState.OnToggleSettings?.Invoke();
    }

    private void ToggleHelp()
    {
        ShowHelp = !ShowHelp;
        StateHasChanged();
    }

    private void ToggleTransformationLog()
    {
        ShowTransformationLog = !ShowTransformationLog;
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        ToolbarState.OnChange -= StateHasChanged;
    }
}
