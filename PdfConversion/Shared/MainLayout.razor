@inherits LayoutComponentBase
@using PdfConversion.Services
@using PdfConversion.Shared
@inject NavigationManager Navigation
@inject DevelopmentToolbarState ToolbarState
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>PdfConversion</PageTitle>

<div class="page">
    <header class="top-nav">
        <nav class="nav-links">
            <NavLink href="/" class="nav-link" Match="NavLinkMatch.All">Home</NavLink>
            <NavLink href="/development" class="nav-link">Development</NavLink>
            <NavLink href="/convert" class="nav-link">Convert</NavLink>
            <NavLink href="/production" class="nav-link">Production</NavLink>
        </nav>

        @if (IsOnDevelopmentPage)
        {
            <div class="nav-toolbar">
                <div class="nav-toolbar-actions">
                    <button class="btn btn-sm btn-outline-light" @onclick="OnToggleSettings" title="Settings" data-bs-toggle="tooltip">
                        <i class="bi bi-gear-fill"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" @onclick="ToggleTransformationLog" title="View Transformation Logs" data-bs-toggle="tooltip">
                        <i class="bi bi-journal-text"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" @onclick="ToggleHelp" title="Help (?)" data-bs-toggle="tooltip">
                        <i class="bi bi-question-circle"></i>
                    </button>
                </div>
            </div>
        }
    </header>

    <main>
        <article class="content">
            @Body
        </article>
    </main>

    <ToastNotification />
    <HelpPanel IsVisible="@ShowHelp" OnClose="ToggleHelp" />
    <TransformationLogPanel IsVisible="@ShowTransformationLog" OnClose="ToggleTransformationLog" />
</div>

@code {
    private bool IsOnDevelopmentPage => Navigation.Uri.Contains("/development", StringComparison.OrdinalIgnoreCase);
    private bool ShowHelp = false;
    private bool ShowTransformationLog = false;

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
        ToolbarState.OnChange += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // ThemeManager auto-initializes when shortcuts.js loads (no call needed here)

            // Initialize tooltips for dynamically rendered elements
            try
            {
                await JSRuntime.InvokeVoidAsync("TooltipManager.initialize");
            }
            catch (Exception)
            {
                // TooltipManager may not be loaded during prerendering, ignore
            }
        }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    private async Task OnTransform()
    {
        if (ToolbarState.OnTransform != null)
        {
            await ToolbarState.OnTransform();
        }
    }

    private async Task OnSave()
    {
        if (ToolbarState.OnSave != null)
        {
            await ToolbarState.OnSave();
        }
    }

    private void OnToggleSettings()
    {
        ToolbarState.OnToggleSettings?.Invoke();
    }

    private void ToggleHelp()
    {
        ShowHelp = !ShowHelp;
        StateHasChanged();
    }

    private void ToggleTransformationLog()
    {
        ShowTransformationLog = !ShowTransformationLog;
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        ToolbarState.OnChange -= StateHasChanged;
    }
}
