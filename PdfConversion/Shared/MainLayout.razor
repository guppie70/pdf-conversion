@inherits LayoutComponentBase
@using PdfConversion.Services
@using PdfConversion.Shared
@inject NavigationManager Navigation
@inject DevelopmentToolbarState ToolbarState
@inject ThemeService ThemeService
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>PdfConversion</PageTitle>

<div class="page">
    <header class="top-nav">
        <nav class="nav-links">
            <NavLink href="/" class="nav-link" Match="NavLinkMatch.All">Home</NavLink>
            <NavLink href="/development" class="nav-link">Development</NavLink>
            <NavLink href="/convert" class="nav-link">Convert</NavLink>
            <NavLink href="/production" class="nav-link">Production</NavLink>
        </nav>

        @if (IsOnDevelopmentPage)
        {
            <div class="nav-toolbar">
                <select class="form-select form-select-sm toolbar-select" @onchange="OnProjectChanged" disabled="@ToolbarState.IsLoading">
                    <option value="">Project...</option>
                    @if (ToolbarState.Projects != null)
                    {
                        @foreach (var project in ToolbarState.Projects)
                        {
                            <option value="@project.ProjectId" selected="@(ToolbarState.SelectedProjectId == project.ProjectId)">
                                @project.Name (@project.FileCount)
                            </option>
                        }
                    }
                </select>

                <select class="form-select form-select-sm toolbar-select" @onchange="OnFileChanged" disabled="@(ToolbarState.IsLoading || string.IsNullOrEmpty(ToolbarState.SelectedProjectId))">
                    <option value="">File...</option>
                    @if (ToolbarState.ProjectFiles != null)
                    {
                        @foreach (var file in ToolbarState.ProjectFiles)
                        {
                            <option value="@file" selected="@(ToolbarState.SelectedFileName == file)">@file</option>
                        }
                    }
                </select>

                <div class="nav-toolbar-actions">
                    <button class="btn btn-sm btn-light" @onclick="OnTransform" disabled="@(!ToolbarState.CanTransform || ToolbarState.IsTransforming)" title="Transform (Ctrl+Enter)" data-bs-toggle="tooltip">
                        @if (ToolbarState.IsTransforming)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        else
                        {
                            <i class="bi bi-play-fill"></i>
                        }
                    </button>
                    <button class="btn btn-sm btn-success" @onclick="OnSave" disabled="@(!ToolbarState.CanSave || ToolbarState.IsSaving)" title="Save XSLT (Ctrl+S)" data-bs-toggle="tooltip">
                        @if (ToolbarState.IsSaving)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        else
                        {
                            <i class="bi bi-save"></i>
                        }
                    </button>
                    <button class="btn btn-sm btn-outline-light" @onclick="OnToggleSettings" title="Settings" data-bs-toggle="tooltip">
                        <i class="bi bi-gear-fill"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" @onclick="ToggleTransformationLog" title="View Transformation Logs" data-bs-toggle="tooltip">
                        <i class="bi bi-journal-text"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" @onclick="ToggleHelp" title="Help (?)" data-bs-toggle="tooltip">
                        <i class="bi bi-question-circle"></i>
                    </button>
                    <label class="theme-toggle ms-2" title="Toggle dark/light theme">
                        <input type="checkbox" checked="@(ThemeService.CurrentTheme == "dark")" @onchange="ToggleTheme">
                        <span class="theme-toggle-slider"></span>
                        <i class="bi bi-sun-fill theme-toggle-icon sun"></i>
                        <i class="bi bi-moon-fill theme-toggle-icon moon"></i>
                    </label>
                </div>
            </div>
        }
    </header>

    <main>
        <article class="content">
            @Body
        </article>
    </main>

    <ToastNotification />
    <HelpPanel IsVisible="@ShowHelp" OnClose="ToggleHelp" />
    <TransformationLogPanel IsVisible="@ShowTransformationLog" OnClose="ToggleTransformationLog" />
</div>

@code {
    private bool IsOnDevelopmentPage => Navigation.Uri.Contains("/development", StringComparison.OrdinalIgnoreCase);
    private bool ShowHelp = false;
    private bool ShowTransformationLog = false;

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
        ToolbarState.OnChange += StateHasChanged;
        ThemeService.OnThemeChanged += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // ThemeManager auto-initializes when shortcuts.js loads (no call needed here)

            // Initialize tooltips for dynamically rendered elements
            try
            {
                await JSRuntime.InvokeVoidAsync("TooltipManager.initialize");
            }
            catch (Exception)
            {
                // TooltipManager may not be loaded during prerendering, ignore
            }
        }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    private async Task OnProjectChanged(ChangeEventArgs e)
    {
        if (ToolbarState.OnProjectChanged != null)
        {
            await ToolbarState.OnProjectChanged(e.Value?.ToString() ?? "");
        }
    }

    private async Task OnFileChanged(ChangeEventArgs e)
    {
        if (ToolbarState.OnFileChanged != null)
        {
            await ToolbarState.OnFileChanged(e.Value?.ToString() ?? "");
        }
    }

    private async Task OnTransform()
    {
        if (ToolbarState.OnTransform != null)
        {
            await ToolbarState.OnTransform();
        }
    }

    private async Task OnSave()
    {
        if (ToolbarState.OnSave != null)
        {
            await ToolbarState.OnSave();
        }
    }

    private void OnToggleSettings()
    {
        ToolbarState.OnToggleSettings?.Invoke();
    }

    private void ToggleHelp()
    {
        ShowHelp = !ShowHelp;
        StateHasChanged();
    }

    private void ToggleTransformationLog()
    {
        ShowTransformationLog = !ShowTransformationLog;
        StateHasChanged();
    }

    private async Task ToggleTheme()
    {
        var newTheme = await JSRuntime.InvokeAsync<string>("ThemeManager.toggleTheme");
        ThemeService.SetTheme(newTheme);
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        ToolbarState.OnChange -= StateHasChanged;
        ThemeService.OnThemeChanged -= StateHasChanged;
    }
}
