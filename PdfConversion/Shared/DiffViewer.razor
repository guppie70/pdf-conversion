@using PdfConversion.Services
@using DiffPlex.DiffBuilder.Model
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime
@inject ILogger<DiffViewer> Logger

<div class="diff-viewer">
    @if (ValidationResult == null)
    {
        <div class="text-center text-muted p-4">
            <i class="bi bi-info-circle"></i> No validation results to display
        </div>
    }
    else if (!ValidationResult.Success)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> <strong>Validation Error:</strong> @ValidationResult.ErrorMessage
        </div>
    }
    else if (ValidationResult.IsPerfectMatch)
    {
        <div class="alert alert-success">
            <i class="bi bi-check-circle-fill"></i>
            <strong>Perfect Match!</strong>
            <p class="mb-0 mt-2">
                The reconstructed document matches the original perfectly. All @ValidationResult.LinesUnchanged lines are identical.
            </p>
        </div>
        <div class="validation-stats">
            <div class="stat-item">
                <span class="stat-label">Duration:</span>
                <span class="stat-value">@ValidationResult.Duration.TotalSeconds.ToString("F2")s</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Lines Matched:</span>
                <span class="stat-value text-success">@ValidationResult.LinesUnchanged</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Match Percentage:</span>
                <span class="stat-value text-success">100%</span>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-circle"></i>
            <strong>Differences Found</strong>
            <p class="mb-0 mt-2">
                The reconstructed document differs from the original in @ValidationResult.TotalDifferences location(s).
            </p>
        </div>

        <div class="validation-stats">
            <div class="stat-item">
                <span class="stat-label">Duration:</span>
                <span class="stat-value">@ValidationResult.Duration.TotalSeconds.ToString("F2")s</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Match Percentage:</span>
                <span class="stat-value">@ValidationResult.MatchPercentage.ToString("F2")%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Lines Unchanged:</span>
                <span class="stat-value text-muted">@ValidationResult.LinesUnchanged</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Lines Modified:</span>
                <span class="stat-value text-warning">@ValidationResult.LinesModified</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Lines Added:</span>
                <span class="stat-value text-success">@ValidationResult.LinesAdded</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Lines Deleted:</span>
                <span class="stat-value text-danger">@ValidationResult.LinesDeleted</span>
            </div>
        </div>

        @if (ValidationResult.DiffResult != null)
        {
            <div class="diff-content @(isFullscreen ? "fullscreen" : "")" @onkeydown="HandleKeyDown" tabindex="0">
                <div class="diff-header">
                    <div class="diff-header-left">
                        <h6>Side-by-Side Comparison</h6>
                        <small class="text-muted">Original (left) vs Reconstructed (right)</small>
                    </div>
                    <div class="diff-header-center">
                        <div class="nav-button-group">
                            <button class="btn btn-sm btn-outline-secondary nav-btn"
                                    @onclick="JumpToPreviousDifference"
                                    disabled="@(!hasPreviousDifference)"
                                    title="Previous Difference">
                                <i class="bi bi-arrow-up-circle"></i>
                                <span>Previous</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary nav-btn"
                                    @onclick="JumpToNextDifference"
                                    disabled="@(!hasNextDifference)"
                                    title="Next Difference">
                                <i class="bi bi-arrow-down-circle"></i>
                                <span>Next</span>
                            </button>
                        </div>
                    </div>
                    <div class="diff-header-controls">
                        <label class="sync-toggle-label">
                            <input type="checkbox"
                                   @bind="isSyncScrollEnabled"
                                   @bind:after="OnSyncScrollToggled" />
                            <span>Synchronized Scrolling</span>
                        </label>
                        <button class="btn btn-sm btn-outline-secondary fullscreen-btn" @onclick="ToggleFullscreen">
                            <i class="bi bi-@(isFullscreen ? "fullscreen-exit" : "fullscreen")"></i>
                            <span>@(isFullscreen ? "Exit Fullscreen" : "Fullscreen")</span>
                        </button>
                    </div>
                </div>
                <div class="diff-viewer-container">
                    <!-- Left Panel: Original XML -->
                    <div class="diff-panel diff-panel-left">
                        <div class="diff-panel-header">Original XML (Fresh Transformation)</div>
                        <div id="diffPanelLeft" class="diff-panel-content">
                            @foreach (var line in ValidationResult.DiffResult.OldTextLines.Select((l, i) => new { Line = l, Index = i }))
                            {
                                <div class="diff-line @GetLineClass(line.Line.Type)">
                                    <div class="diff-line-number">@(line.Index + 1)</div>
                                    <div class="diff-line-content">@(string.IsNullOrWhiteSpace(line.Line.Text) ? " " : line.Line.Text)</div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="diff-panel-divider"></div>

                    <!-- Right Panel: Reconstructed XML -->
                    <div class="diff-panel diff-panel-right">
                        <div class="diff-panel-header">Reconstructed XML (From Sections)</div>
                        <div id="diffPanelRight" class="diff-panel-content">
                            @foreach (var line in ValidationResult.DiffResult.NewTextLines.Select((l, i) => new { Line = l, Index = i }))
                            {
                                <div class="diff-line @GetLineClass(line.Line.Type)">
                                    <div class="diff-line-number">@(line.Index + 1)</div>
                                    <div class="diff-line-content">@(string.IsNullOrWhiteSpace(line.Line.Text) ? " " : line.Line.Text)</div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public RoundTripValidationResult? ValidationResult { get; set; }

    private bool isSyncScrollEnabled = true;
    private bool isFullscreen = false;
    private bool hasNextDifference = true;
    private bool hasPreviousDifference = false;
    private IJSObjectReference? diffViewerModule;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                diffViewerModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/diff-viewer.js?v=4");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to load diff-viewer.js module");
            }
        }

        // Initialize or update sync scroll when validation result is available
        if (ValidationResult?.DiffResult != null && diffViewerModule != null)
        {
            try
            {
                if (isSyncScrollEnabled)
                {
                    await diffViewerModule.InvokeVoidAsync("initializeSyncScroll", "diffPanelLeft", "diffPanelRight");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to initialize synchronized scrolling");
            }
        }
    }

    private async Task OnSyncScrollToggled()
    {
        if (diffViewerModule == null) return;

        try
        {
            if (isSyncScrollEnabled)
            {
                await diffViewerModule.InvokeVoidAsync("enableSyncScroll", "diffPanelLeft", "diffPanelRight");
            }
            else
            {
                await diffViewerModule.InvokeVoidAsync("disableSyncScroll", "diffPanelLeft", "diffPanelRight");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to toggle synchronized scrolling");
        }
    }

    private string GetLineClass(ChangeType changeType)
    {
        return changeType switch
        {
            ChangeType.Unchanged => "line-unchanged",
            ChangeType.Deleted => "line-deleted",
            ChangeType.Inserted => "line-inserted",
            ChangeType.Modified => "line-modified",
            ChangeType.Imaginary => "line-imaginary",
            _ => "line-unchanged"
        };
    }

    private void ToggleFullscreen()
    {
        isFullscreen = !isFullscreen;
        Logger.LogInformation("Fullscreen mode {Mode}", isFullscreen ? "enabled" : "disabled");
    }

    private async Task JumpToNextDifference()
    {
        if (diffViewerModule == null) return;

        try
        {
            var found = await diffViewerModule.InvokeAsync<bool>("jumpToNextDifference", "diffPanelLeft", "diffPanelRight");

            if (!found)
            {
                hasNextDifference = false;
                Logger.LogInformation("Already at last difference");
            }

            // Update button states
            await UpdateNavigationButtonStates();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to jump to next difference");
        }
    }

    private async Task JumpToPreviousDifference()
    {
        if (diffViewerModule == null) return;

        try
        {
            var found = await diffViewerModule.InvokeAsync<bool>("jumpToPreviousDifference", "diffPanelLeft", "diffPanelRight");

            if (!found)
            {
                hasPreviousDifference = false;
                Logger.LogInformation("Already at first difference");
            }

            // Update button states
            await UpdateNavigationButtonStates();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to jump to previous difference");
        }
    }

    private async Task UpdateNavigationButtonStates()
    {
        // This method checks if there are more differences in either direction
        // For now, we enable both buttons after each navigation
        // A more sophisticated implementation could track the current position
        hasNextDifference = true;
        hasPreviousDifference = true;
        await Task.CompletedTask;
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape" && isFullscreen)
        {
            isFullscreen = false;
            Logger.LogInformation("Fullscreen mode exited via ESC key");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (diffViewerModule != null)
        {
            try
            {
                await diffViewerModule.DisposeAsync();
            }
            catch
            {
                // Ignore disposal errors
            }
        }
    }
}
